#!/bin/bash 
# This script processes a norg formatted doc from stdin line-by-line
# If the line matches the format for the an expense it processes the
# expense line and stores information about it.
#
# After processes all expense lines it prints a summary at the end 
# which is also in a norg-friendly format.

total_expenses=0
total_cash_back=0
declare -A expenses
declare -A vendors
declare -A categories
declare -A dates
declare -A payment_methods


# Only printed if script is called with DEBUG_PRINT is set
debug_output() {
        echo "${expense}"
        echo "${vendor}"
        echo "${category}"
        echo "${amount}"
        echo "${date}"
        echo "${payment_method}"
        echo "${cash_back_rate}"
        echo ""
        echo "${!expenses[@]}"
        echo "${expenses[@]}"
        echo ""
        echo "${!vendors[@]}"
        echo "${vendors[@]}"
        echo ""
        echo "${!categories[@]}"
        echo "${categories[@]}"
        echo ""
        echo "${!dates[@]}"
        echo "${dates[@]}"
        echo ""
        echo "${!payment_methods[@]}"
        echo "${payment_methods[@]}"
        echo "--------------"
}


# Process stdin
while IFS= read -r line 
do 
    # Line must be printed. We are note deleting, we are only
    # processing and then summarizing
    echo "${line}"
    
    # Match text entry, example:
    # - humble monthly | humblebundle | subscriptions | $11.99 | 2025-01-24 | amex-platinum | 1.00%
    #
    # Uses the following form:
    # - expense | vendor | category | amount | date | payment_method | cash_back_rate
    if [[ "${line}" =~ ^\ {1,4}-\ [0-9a-zA-Z] ]]
    then 
        # Use awk to index into the line split by the pipe, and use xargs trick
        # to truncate extra whitespace
        expense=$(awk -F'|' '{ printf "%s\n", $1 }' <<< "${line}")
        expense=$(xargs <<< "${expense//-/}") # remove leading '- ' 
        vendor=$(awk -F'|' '{ printf "%s\n", $2 }' <<< "${line}" | xargs)
        category=$(awk -F'|' '{ printf "%s\n", $3 }' <<< "${line}" | xargs)
        amount=$(awk -F'|' '{ printf "%s\n", $4 }' <<< "${line}")
        amount=$(xargs <<< "${amount//\$/}")
        date=$(awk -F'|' '{ printf "%s\n", $5 }' <<< "${line}" | xargs)
        payment_method=$(awk -F'|' '{ printf "%s\n", $6 }' <<< "${line}" | xargs)
        cash_back_rate=$(awk -F'|' '{ printf "%s\n", $7 }' <<< "${line}" | xargs)

        # Sum total expenses, removing "$" while doing so
        # We use $(bc) since it supports floating point
        total_expenses=$(bc <<< "${total_expenses}+${amount}")
        
        # Calculate the cash back by calculating this purchases cash back rate 
        # multiplied by the expense. We then sum that to total_cash_back
        this_cash_back=$(bc <<< "${amount}*${cash_back_rate//%/}*0.01")
        total_cash_back=$(bc <<< "${total_cash_back}+${this_cash_back}")
        

        # For each associative array, check if the key exists:
        # - if so, sum together current key's value with this expenses amount
        # - if not, then set the current key's value to the current expense
        if [[ -v expenses["${expense}"] ]]
        then 
            expenses["${expense}"]=$(bc <<< "${expenses[${expense}]}+${amount}")
        else 
            expenses["${expense}"]="${amount}"
        fi

        if [[ -v vendors["${vendor}"] ]]
        then 
            vendors["${vendor}"]=$(bc <<< "${vendors[${vendor}]}+${amount}")
        else 
            vendors["${vendor}"]="${amount}"
        fi
        
        if [[ -v categories["${category}"] ]]
        then 
            categories["${category}"]=$(bc <<< "${categories[${category}]}+${amount}")
        else 
            categories["${category}"]="${amount}"
        fi
        
        if [[ -v dates["${date}"] ]]
        then 
            dates["${date}"]=$(bc <<< "${dates[${date}]}+${amount}")
        else 
            dates["${date}"]="${amount}"
        fi

        if [[ -v payment_methods["${payment_method}"] ]]
        then 
            payment_methods["${payment_method}"]=$(bc <<< "${payment_methods[${payment_method}]}+${amount}")
        else 
            payment_methods["${payment_method}"]="${amount}"
        fi

        
        # If DEBUG_PRINT is set, call debug_output function
        if [[ -v DEBUG_PRINT ]]; then debug_output; fi

    fi

done

# Print output in norg format
echo " * spending summary"
echo "   - total expenses: \$${total_expenses}"
echo "   - total cash-back: \$${total_cash_back}"
echo "  * spending by expense-type"

# Iterate expenses
for key in $(printf "%s\n" "${!expenses[@]}" | sort)
do 
    echo "    - ${key}: ${expenses[${key}]}"
done

# Iterate vendors
echo "  * spending by vendor"
for key in $(printf "%s\n" "${!vendors[@]}" | sort)
do 
    echo "    - ${key}: ${vendors[${key}]}"
done

# Iterate categories
echo "  * spending by category"
for key in $(printf "%s\n" "${!categories[@]}" | sort)
do 
    echo "    - ${key}: ${categories[${key}]}"
done

# Iterate dates
echo "  * spending by date"
for key in $(printf "%s\n" "${!dates[@]}" | sort)
do 
    echo "    - ${key}: ${dates[${key}]}"
done

# Iterate payment_methods
echo "  * spending by payment-method"
for key in $(printf "%s\n" "${!payment_methods[@]}" | sort)
do 
    echo "    - ${key}: ${payment_methods[${key}]}"
done

