#!/bin/bash 
# This script processes a markdown formatted doc from stdin line-by-line
# If the line matches the format for the an expense it processes the
# expense line and stores information about it.
#
# After processes all expense lines it prints a summary at the end 
# which is also in a markdown-friendly format.

total_expenses=0
total_cash_back=0
declare -A expenses
declare -A vendors
declare -A categories
declare -A dates
declare -A payment_methods

in_table=0 
read_header=0
table_text=""
header_separator_found=0


# Only printed if script is called with DEBUG_PRINT is set
debug_output() {
        echo "${expense}"
        echo "${vendor}"
        echo "${category}"
        echo "${amount}"
        echo "${date}"
        echo "${payment_method}"
        echo "${cash_back_rate}"
        echo ""
        echo "${!expenses[@]}"
        echo "${expenses[@]}"
        echo ""
        echo "${!vendors[@]}"
        echo "${vendors[@]}"
        echo ""
        echo "${!categories[@]}"
        echo "${categories[@]}"
        echo ""
        echo "${!dates[@]}"
        echo "${dates[@]}"
        echo ""
        echo "${!payment_methods[@]}"
        echo "${payment_methods[@]}"
        echo "--------------"
}


# Process stdin
while IFS= read -r line 
do 
    # Line must be printed. We are note deleting, we are only
    # processing and then summarizing
    echo "${line}"

    # Detect markdown table start (line with pipes)
    if [[ "${line}" =~ ^\|.*\|$ ]] && [[ "${in_table}" -eq 0 ]]
    then 
        in_table=1
        read_header=0
        header_separator_found=0
    fi

    # Detect markdown table header separator row (|---|---|
    if [[ "${in_table}" -eq 1 ]] && [[ "${line}" =~ ^\|[-[:space:]]+\| ]]
    then
        header_separator_found=1
        continue
    fi
    
    # Detect end of table (empty line or non-pipe line)
    if [[ "${in_table}" -eq 1 ]] && [[ ! "${line}" =~ ^\|.*\|$ ]] && [[ "${line}" != "" ]]
    then 
        in_table=0
        read_header=0
        header_separator_found=0
    fi
    
    # Set read_header after we've seen the separator row
    if [[ "${in_table}" -eq 1 ]] && [[ "${header_separator_found}" -eq 1 ]] && [[ "${read_header}" -eq 0 ]]
    then
        read_header=1
    fi

    # Match table entry, example:
    # | humble monthly | humblebundle | subscriptions | $11.99 | 2025-01-24 | amex-platinum | 1.00 |
    #
    # Uses the following form:
    # | expense | vendor | category | amount | date | payment_method | cash_back_rate |
    if [[ "${in_table}" -eq 1 ]] && [[ "${read_header}" -eq 1 ]] && [[ "${line}" =~ ^\|.*\|$ ]]
    then 
        # Use awk to index into the line split by the pipe, and use xargs trick
        # to truncate extra whitespace
        expense=$(awk -F'|' '{ printf "%s\n", $2 }' <<< "${line}" | xargs) # $2 because $1 is empty due to leading | 
        vendor=$(awk -F'|' '{ printf "%s\n", $3 }' <<< "${line}" | xargs)
        category=$(awk -F'|' '{ printf "%s\n", $4 }' <<< "${line}" | xargs)
        amount=$(awk -F'|' '{ printf "%s\n", $5 }' <<< "${line}")
        amount=$(xargs <<< "${amount//\$/}")
        date=$(awk -F'|' '{ printf "%s\n", $6 }' <<< "${line}" | xargs)
        payment_method=$(awk -F'|' '{ printf "%s\n", $7 }' <<< "${line}" | xargs)
        cash_back_rate=$(awk -F'|' '{ printf "%s\n", $8 }' <<< "${line}" | xargs)

        # Sum total expenses, removing "$" while doing so
        # We use $(bc) since it supports floating point
        total_expenses=$(bc <<< "${total_expenses}+${amount}")
        
        # Calculate the cash back by calculating this purchases cash back rate 
        # multiplied by the expense. We then sum that to total_cash_back
        this_cash_back=$(bc <<< "${amount}*${cash_back_rate//%/}*0.01")
        total_cash_back=$(bc <<< "${total_cash_back}+${this_cash_back}")
        

        # For each associative array, check if the key exists:
        # - if so, sum together current key's value with this expenses amount
        # - if not, then set the current key's value to the current expense
        if [[ -v expenses["${expense}"] ]]
        then 
            expenses["${expense}"]=$(bc <<< "${expenses[${expense}]}+${amount}")
        else 
            expenses["${expense}"]="${amount}"
        fi

        if [[ -v vendors["${vendor}"] ]]
        then 
            vendors["${vendor}"]=$(bc <<< "${vendors[${vendor}]}+${amount}")
        else 
            vendors["${vendor}"]="${amount}"
        fi
        
        if [[ -v categories["${category}"] ]]
        then 
            categories["${category}"]=$(bc <<< "${categories[${category}]}+${amount}")
        else 
            categories["${category}"]="${amount}"
        fi
        
        if [[ -v dates["${date}"] ]]
        then 
            dates["${date}"]=$(bc <<< "${dates[${date}]}+${amount}")
        else 
            dates["${date}"]="${amount}"
        fi

        if [[ -v payment_methods["${payment_method}"] ]]
        then 
            payment_methods["${payment_method}"]=$(bc <<< "${payment_methods[${payment_method}]}+${amount}")
        else 
            payment_methods["${payment_method}"]="${amount}"
        fi

        
        # If DEBUG_PRINT is set, call debug_output function
        if [[ -v DEBUG_PRINT ]]; then debug_output; fi

    fi

done


# Print output in markdown format
# first up is the summary
echo "## spending summary"
printf -v table_text "| summary | amount |\n" 
printf -v table_text "%s|---------|--------|\n" "${table_text}"
printf -v table_text "%s| expense | \$%s |\n" "${table_text}" "${total_expenses}"
printf -v table_text "%s| cash-back | \$%s |\n" "${table_text}" "${total_cash_back}"
echo "${table_text}"


# Iterate expenses
echo "### spending by expense-type"
printf -v table_text "| expense | amount |\n" 
printf -v table_text "%s|---------|--------|\n" "${table_text}"
for key in $(printf "%s\n" "${!expenses[@]}" | sort)
do 
    printf -v table_text "%s| %s | %s |\n" "${table_text}" "${key}" "${expenses[${key}]}"
done
echo "${table_text}"


# Iterate vendors
echo "### spending by vendor"
printf -v table_text "| vendor | amount |\n" 
printf -v table_text "%s|--------|--------|\n" "${table_text}"
for key in $(printf "%s\n" "${!vendors[@]}" | sort)
do 
    printf -v table_text "%s| %s | %s |\n" "${table_text}" "${key}" "${vendors[${key}]}"
done
echo "${table_text}"


# Iterate categories
echo "### spending by category"
printf -v table_text "| category | amount |\n" 
printf -v table_text "%s|----------|--------|\n" "${table_text}"
for key in $(printf "%s\n" "${!categories[@]}" | sort)
do 
    printf -v table_text "%s| %s | %s |\n" "${table_text}" "${key}" "${categories[${key}]}"
done
echo "${table_text}"


# Iterate dates
echo "### spending by date"
printf -v table_text "| date | amount |\n" 
printf -v table_text "%s|------|--------|\n" "${table_text}"
for key in $(printf "%s\n" "${!dates[@]}" | sort)
do 
    printf -v table_text "%s| %s | %s |\n" "${table_text}" "${key}" "${dates[${key}]}"
done
echo "${table_text}"


# Iterate payment_methods
echo "### spending by payment-method"
printf -v table_text "| payment-method | amount |\n" 
printf -v table_text "%s|----------------|--------|\n" "${table_text}"
for key in $(printf "%s\n" "${!payment_methods[@]}" | sort)
do 
    printf -v table_text "%s| %s | %s |\n" "${table_text}" "${key}" "${payment_methods[${key}]}"
done
echo "${table_text}"

