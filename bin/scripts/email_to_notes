#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# email_to_notes - Pipe email from neomutt to second brain via fsbi
#
# Usage:
#   cat email.eml | email_to_notes
#   <pipe-message> from neomutt
#
# This script reads a raw RFC822 email from stdin, converts it to markdown,
# and uses fsbi for interactive PARA directory selection.

set -euo pipefail

show_help () {
    cat << 'EOF'
email_to_notes - Save email to second brain via fsbi

Usage:
    cat email.eml | email_to_notes
    (in neomutt: <pipe-message>email_to_notes<enter>)

Options:
    -h, --help      Show this help message
    --license       Show license information

Description:
    Reads a raw RFC822 email from stdin, extracts the subject for filename,
    converts to markdown via email_to_markdown, then uses fsbi for interactive
    PARA directory selection.

Requirements:
    - email_to_markdown (for converting email to markdown)
    - fsbi (for interactive PARA selection)

Examples:
    # From command line
    cat ~/mail/cur/email.eml | email_to_notes

    # From neomutt (via macro)
    Press <Esc>s to save current email to notes
EOF
}

show_license () {
    cat << 'EOF'
email_to_notes - Save email to second brain via fsbi
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]
do
    case "${1}" in
        -h|--help)
            show_help
            exit 0
            ;;
        --license)
            show_license
            exit 0
            ;;
        *)
            echo "Unknown option: ${1}" >&2
            echo "Use -h or --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Check dependencies
if ! command -v email_to_markdown &>/dev/null
then
    echo "Error: email_to_markdown not found in PATH" >&2
    exit 1
fi

if ! command -v fsbi &>/dev/null
then
    echo "Error: fsbi not found in PATH" >&2
    exit 1
fi

# Read email from stdin to temp file (need file for subject extraction)
tmp_email=$(mktemp --suffix=.eml)
trap "rm -f ${tmp_email}" EXIT
cat > "${tmp_email}"

# Verify we got some content
if [[ ! -s "${tmp_email}" ]]
then
    echo "Error: No email content received from stdin" >&2
    exit 1
fi

# Extract subject for filename seed
# Look for Subject: header, clean it up for use as filename
subject=$(grep -m1 -i "^Subject:" "${tmp_email}" | sed 's/^[Ss]ubject: //' | tr -cd '[:alnum:] _-' | tr ' ' '_' | cut -c1-50)
date_prefix=$(date +%Y-%m-%d)
name_seed="${date_prefix}_${subject:-email}"

# Convert to markdown temp file
tmp_md=$(mktemp --suffix=.md)
trap "rm -f ${tmp_email} ${tmp_md}" EXIT
email_to_markdown -i "${tmp_email}" -o "${tmp_md}"

# Verify conversion succeeded
if [[ ! -s "${tmp_md}" ]]
then
    echo "Error: email_to_markdown produced empty output" >&2
    exit 1
fi

# Use fsbi for interactive PARA selection (no AI summary by default)
fsbi --no-summary --name-seed "${name_seed}" "${tmp_md}"
