#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
file_age - Human-readable file age

USAGE:
	file_age [OPTIONS] <file>

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--seconds       Output raw seconds
	--mtime         Use modification time (default)
	--ctime         Use change time
	--atime         Use access time

EXAMPLES:
	file_age ~/.bashrc
	file_age /var/log/app.log --seconds
	file_age document.pdf --atime

EOF
}

time_type="mtime"
raw_seconds=false
file=""

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--seconds) raw_seconds=true; shift ;;
		--mtime) time_type="mtime"; shift ;;
		--ctime) time_type="ctime"; shift ;;
		--atime) time_type="atime"; shift ;;
		*)
			if [[ -z "$file" ]]; then
				file="${1}"
				shift
			else
				echo "Error: unexpected argument '$1'" >&2
				exit 1
			fi
			;;
	esac
done

if [[ -z "$file" ]]; then
	echo "Error: file argument required" >&2
	exit 1
fi

if [[ ! -e "$file" ]]; then
	echo "Error: file not found: $file" >&2
	exit 1
fi

# Get file modification time
case "$time_type" in
	mtime) file_time=$(stat -c %Y "$file") ;;
	ctime) file_time=$(stat -c %Z "$file") ;;
	atime) file_time=$(stat -c %X "$file") ;;
	*) echo "Error: invalid time type" >&2; exit 1 ;;
esac

current_time=$(date +%s)
age_seconds=$((current_time - file_time))

if [[ "$raw_seconds" == true ]]; then
	echo "$age_seconds"
else
	# Convert to human-readable format
	if [[ $age_seconds -lt 60 ]]; then
		echo "$age_seconds seconds ago"
	elif [[ $age_seconds -lt 3600 ]]; then
		minutes=$((age_seconds / 60))
		echo "$minutes minute$(( minutes != 1 ? s : '')) ago"
	elif [[ $age_seconds -lt 86400 ]]; then
		hours=$((age_seconds / 3600))
		echo "$hours hour$(( hours != 1 ? s : '')) ago"
	elif [[ $age_seconds -lt 604800 ]]; then
		days=$((age_seconds / 86400))
		echo "$days day$(( days != 1 ? s : '')) ago"
	else
		weeks=$((age_seconds / 604800))
		echo "$weeks week$(( weeks != 1 ? s : '')) ago"
	fi
fi
