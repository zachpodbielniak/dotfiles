#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# example usage 
# - recursive_sbi -t '*.html' --markdown --no-summary --category technical/docs/perl_5.38 --para resource

arg_type=""
arg_category=""
args_for_sbi=()

print_help() {
    echo -e "Usage: $(basename ${0}) <args>"
    echo -e "  -h,--help\t\tprint this message"
    echo -e "  -t,--file-type\ttype of file ('*.html', '*.md', etc.)"
    echo -e "  -c,--category\tcategory (sub dirs are appended)"
}

while [[ $# -gt 0 ]]
do 
    case "${1}" in 
        -h|--help)
            print_help
            exit 0 
            ;; 
        -t|--file-type)
            arg_type="${2}"
            shift 
            ;;
        -c|--category)
            arg_category="${2}"
            shift 
            ;;
        *)
            args_for_sbi+=("${1}")
            ;;
    esac
    shift
done

files=$(find . -type f -name "${arg_type}")

while read -r file
do 
    dir="$(dirname "${file}")"
    if [[ "" != "${arg_category}" ]]
    then
        cmd="sbi ${args_for_sbi[@]} --category "${arg_category}/${dir:2}" "${file}""
        echo "running ${cmd}"
        
        # prevent it from consuming the rest of the heredoc for the loop
        bash -c "${cmd}" < /dev/null
    else 
        cmd="sbi ${args_for_sbi[@]} --category "${dir:2}" "${file}""
        echo "running ${cmd}"
        
        # prevent it from consuming the rest of the heredoc for the loop
        bash -c "${cmd}" < /de/null
    fi
done <<< "${files}"

echo "done"

