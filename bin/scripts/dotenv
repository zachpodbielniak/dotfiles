#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
dotenv - Load and export .env file variables

USAGE:
	dotenv [OPTIONS] FILE

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--export        Print export statements (for eval)
	--json          Output as JSON
	--check         Validate syntax only

EXAMPLES:
	dotenv .env
	eval "$(dotenv .env --export)"
	dotenv .env --json | jq .

DESCRIPTION:
	Load variables from a .env file in KEY=VALUE format.
	Supports quoted values and comments.

EOF
}

if [[ $# -lt 1 ]]; then
	usage >&2
	exit 1
fi

format="plain"
check_only=false
envfile=""

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--export)
			format="export"
			shift
			;;
		--json)
			format="json"
			shift
			;;
		--check)
			check_only=true
			shift
			;;
		*)
			envfile="$1"
			shift
			;;
	esac
done

if [[ ! -f "$envfile" ]]; then
	echo "dotenv: file not found: $envfile" >&2
	exit 1
fi

# Parse .env file
declare -A vars=()
while IFS= read -r line || [[ -n "$line" ]]; do
	# Skip empty lines and comments
	[[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

	# Parse KEY=VALUE
	if [[ "$line" =~ ^([A-Za-z_][A-Za-z0-9_]*)[[:space:]]*=[[:space:]]*(.*) ]]; then
		key="${BASH_REMATCH[1]}"
		value="${BASH_REMATCH[2]}"
		# Remove quotes if present
		value="${value%\"}"
		value="${value#\"}"
		vars[$key]="$value"
	else
		# Invalid line
		if [[ ! "$check_only" ]]; then
			echo "dotenv: invalid line: $line" >&2
		fi
		exit 1
	fi
done < "$envfile"

# If check-only, exit with success
[[ "$check_only" == "true" ]] && exit 0

# Output in requested format
case "$format" in
	export)
		for key in "${!vars[@]}"; do
			echo "export ${key}=\"${vars[$key]}\""
		done
		;;
	json)
		echo "{"
		first=true
		for key in "${!vars[@]}"; do
			if [[ "$first" == "true" ]]; then
				first=false
			else
				echo ","
			fi
			printf "  \"%s\": \"%s\"" "$key" "${vars[$key]}"
		done
		echo ""
		echo "}"
		;;
	plain)
		for key in "${!vars[@]}"; do
			echo "$key=${vars[$key]}"
		done
		;;
esac
