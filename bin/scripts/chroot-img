#!/bin/bash 

if [ $# -lt 1 ]
then
  echo "Use this tool correctly!"
  echo "$0 <img_file>"
  exit 1
fi

if [ ! -f "$1" ]
then 
  echo "File not found: $1"
  exit 1
fi 

mkdir -p ./mnt 
LOOP_DEVICE=$(sudo losetup -f --show -P "$1")

if [ "$?" != "0" ]
then 
  echo "Unable to mount $1 as a loop device!"
  exit 1
fi

sudo mount "${LOOP_DEVICE}p2" ./mnt 
sudo mount "${LOOP_DEVICE}p1" ./mnt/boot 
sudo mount --bind /dev ./mnt/dev/
sudo mount --bind /proc ./mnt/proc/
sudo mount --bind /sys ./mnt/sys/
sudo mount --bind /dev/pts ./mnt/dev/pts

sudo chroot ./mnt

# Cleanup 
sudo umount ./mnt/dev/pts
sudo umount ./mnt/dev 
sudo umount ./mnt/sys
sudo umount ./mnt/proc 
sudo umount ./mnt/boot
sudo umount ./mnt 

rmdir ./mnt
sudo losetup -D "$LOOP_DEVICE"
