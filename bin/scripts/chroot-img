#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.


if [ $# -lt 1 ]
then
  echo "Use this tool correctly!"
  echo "$0 <img_file>"
  exit 1
fi

if [ ! -f "$1" ]
then 
  echo "File not found: $1"
  exit 1
fi 

mkdir -p ./mnt 
LOOP_DEVICE=$(sudo losetup -f --show -P "$1")

if [ "$?" != "0" ]
then 
  echo "Unable to mount $1 as a loop device!"
  exit 1
fi

sudo mount "${LOOP_DEVICE}p2" ./mnt 
sudo mount "${LOOP_DEVICE}p1" ./mnt/boot 
sudo mount --bind /dev ./mnt/dev/
sudo mount --bind /proc ./mnt/proc/
sudo mount --bind /sys ./mnt/sys/
sudo mount --bind /dev/pts ./mnt/dev/pts

sudo chroot ./mnt

# Cleanup 
sudo umount ./mnt/dev/pts
sudo umount ./mnt/dev 
sudo umount ./mnt/sys
sudo umount ./mnt/proc 
sudo umount ./mnt/boot
sudo umount ./mnt 

rmdir ./mnt
sudo losetup -D "$LOOP_DEVICE"
