#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

#
# can list pactl modules with
# - pactl list short modules | grep dummy
# can list sources with
# - pactl list short sources

set -uo pipefail

readonly SCRIPT_NAME=$(basename "$0")

# Defaults
filename=""
use_default_input=false

show_help () {
    cat << EOF
Usage: ${SCRIPT_NAME} [OPTIONS] [FILENAME]

Record audio using ffmpeg and PulseAudio/PipeWire.

Options:
    -h, --help      Show this help message
    --license       Show license information
    -d, --default   Use default audio input device instead of dummy.monitor

Arguments:
    FILENAME        Output file path (default: ~/Documents/recordings/YYYY-MM-DD_HH-MM-SS.ogg)

Audio Sources:
    By default, records from dummy.monitor (system audio loopback).
    With --default, records from the default input device (microphone).

Examples:
    # Record system audio to default location
    ${SCRIPT_NAME}

    # Record system audio to specific file
    ${SCRIPT_NAME} ~/recording.ogg

    # Record from microphone (default input)
    ${SCRIPT_NAME} --default

    # Record from microphone to specific file
    ${SCRIPT_NAME} --default ~/voice_note.ogg

Notes:
    - Press Ctrl+C to stop recording
    - dummy.monitor is provided by a systemd user service
    - List available sources: pactl list short sources
EOF
}

show_license () {
    cat << 'EOF'
dotfiles - Personal configuration files and scripts
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]
do
    case "${1}" in
        -h|--help)
            show_help
            exit 0
            ;;
        --license)
            show_license
            exit 0
            ;;
        -d|--default)
            use_default_input=true
            shift
            ;;
        -*)
            printf "Error: Unknown option: %s\n" "${1}" >&2
            printf "Use --help for usage.\n" >&2
            exit 1
            ;;
        *)
            # Positional argument: filename
            filename="${1}"
            shift
            ;;
    esac
done

# Set default filename if not provided
if [[ -z "${filename}" ]]
then
    filename="${HOME}/Documents/recordings/$(date +'%Y-%m-%d_%H-%M-%S').ogg"
fi

# Ensure output directory exists
mkdir -p "$(dirname "${filename}")"

# Select audio input source
if [[ "${use_default_input}" == true ]]
then
    audio_input="default"
else
    # dummy.monitor provided by systemd user service
    audio_input="dummy.monitor"
fi

# Build ffmpeg arguments
ffmpeg_args=(
    "-y"
    "-f"
    "pulse"
    "-i"
    "${audio_input}"
    "${filename}"
)

# Record with ffmpeg
if [[ -f /usr/bin/ffmpeg ]]
then
    /usr/bin/ffmpeg "${ffmpeg_args[@]}"
else
    distrobox enter dev -- /usr/bin/ffmpeg "${ffmpeg_args[@]}"
fi

printf "output: %s\n" "${filename}"
