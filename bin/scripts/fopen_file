#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Default search depth
MAX_DEPTH=6
DRY_RUN=false

# Process command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--depth)
            MAX_DEPTH="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo "Open a file using fzf with directory filtering"
            echo ""
            echo "Options:"
            echo "  -d, --depth NUM    Maximum search depth (default: 6)"
            echo "  --dry-run          Print selected file instead of opening it"
            echo "  -h, --help         Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
done

file_to_open=""

_open_file() {
    find . \
        -maxdepth "${MAX_DEPTH}" \
        \( -name ".git" -o -name "*.calendar" -o -name "*.books" -o -name "*.claude" -o -name "trees" \) -prune \
        -o -type f -print \
        2>/dev/null | \
    fzf --preview 'head -100 {}'
}

file_to_open=$(_open_file) || true

if [[ -n "${file_to_open}" ]]; then 
    if [[ "${DRY_RUN}" == "true" ]]; then
        echo "${file_to_open}"
    else
        exec "${EDITOR:-nvim}" "${file_to_open}"
    fi
fi