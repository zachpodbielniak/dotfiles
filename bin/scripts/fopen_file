#!/bin/bash 
set -euo pipefail

# Default search depth
MAX_DEPTH=6
DRY_RUN=false

# Process command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -d|--depth)
            MAX_DEPTH="$2"
            shift 2
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo "Open a file using fzf with directory filtering"
            echo ""
            echo "Options:"
            echo "  -d, --depth NUM    Maximum search depth (default: 6)"
            echo "  --dry-run          Print selected file instead of opening it"
            echo "  -h, --help         Show this help message"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
done

file_to_open=""

_open_file() {
    find . \
        -maxdepth "${MAX_DEPTH}" \
        \( -name ".git" -o -name "*.calendar" -o -name "*.books" -o -name "*.claude" -o -name "trees" \) -prune \
        -o -type f -print \
        2>/dev/null | \
    fzf --preview 'head -100 {}'
}

file_to_open=$(_open_file) || true

if [[ -n "${file_to_open}" ]]; then 
    if [[ "${DRY_RUN}" == "true" ]]; then
        echo "${file_to_open}"
    else
        exec "${EDITOR:-nvim}" "${file_to_open}"
    fi
fi