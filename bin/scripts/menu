#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
menu - Simple menu selector from stdin

USAGE:
	menu [OPTIONS]

OPTIONS:
	-h, --help       Show this help message
	--license        Show license information
	-p, --prompt STR Custom prompt (default: "Select: ")
	--index          Output index instead of value
	--default N      Pre-select option N (1-indexed)

EXAMPLES:
	echo -e "apple\nbanana\ncherry" | menu
	echo -e "apple\nbanana" | menu --index

DESCRIPTION:
	Present a numbered menu of options from stdin and let user
	select one. Output the selected value (or index with --index).

EOF
}

prompt="Select: "
show_index=false
default=0

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		-p|--prompt)
			prompt="$2"
			shift 2
			;;
		--index)
			show_index=true
			shift
			;;
		--default)
			default="$2"
			shift 2
			;;
		*)
			echo "menu: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Read options into array
mapfile -t options

if [[ ${#options[@]} -eq 0 ]]; then
	echo "menu: no options provided" >&2
	exit 1
fi

# Display menu
for i in "${!options[@]}"; do
	echo "$((i+1))) ${options[$i]}"
done

# Get selection from terminal or fallback
# First, check if /dev/tty is available (interactive terminal)
if [[ -t 1 ]] && [[ -c /dev/tty ]]; then
	# Interactive terminal - read from tty
	read -p "$prompt" choice < /dev/tty
elif [[ -t 0 ]]; then
	# stdin is connected to terminal (not piped)
	read -p "$prompt" choice
else
	# Non-interactive or piped - need explicit input
	# This shouldn't happen in normal usage but handle it gracefully
	echo "menu: unable to get terminal input" >&2
	exit 1
fi

# Validate choice
if ! [[ "$choice" =~ ^[0-9]+$ ]] || ((choice < 1 || choice > ${#options[@]})); then
	echo "menu: invalid selection" >&2
	exit 1
fi

# Output result
index=$((choice - 1))
if [[ "$show_index" == "true" ]]; then
	echo "$choice"
else
	echo "${options[$index]}"
fi

exit 0
