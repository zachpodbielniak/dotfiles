#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
is_json - Validate if input is valid JSON

USAGE:
	is_json [OPTIONS] [STRING]

ARGUMENTS:
	STRING          JSON string to check (if omitted, reads from stdin)

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--quiet         No output, just exit code
	--pretty        If valid, output pretty-printed JSON

EXAMPLES:
	echo '{"a": 1}' | is_json && echo "Valid JSON"
	is_json '{"a": 1}' && echo "Valid JSON"
	is_json '{"a": 1}' --pretty | less
	cat data.json | is_json || echo "Invalid JSON"

DESCRIPTION:
	Exit code 0 if input is valid JSON.
	Exit code 1 if input is not valid JSON.

EOF
}

pretty=false
quiet=false
input_string=""

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--pretty)
			pretty=true
			shift
			;;
		--quiet)
			quiet=true
			shift
			;;
		*)
			# Assume this is the input string (positional argument)
			if [[ -z "$input_string" ]]; then
				input_string="$1"
				shift
			else
				if [[ ! "$quiet" == "true" ]]; then
					echo "is_json: unknown option: $1" >&2
				fi
				exit 1
			fi
			;;
	esac
done

# Determine input source
if [[ -n "$input_string" ]]; then
	content="$input_string"
else
	content=$(cat 2>/dev/null)
fi

# Check if empty
if [[ -z "$content" ]]; then
	if [[ ! "$quiet" == "true" ]]; then
		echo "is_json: empty input" >&2
	fi
	exit 1
fi

# Try to validate and optionally pretty-print using Python
if command -v python3 &>/dev/null; then
	if [[ "$pretty" == "true" ]]; then
		python3 -c "import json, sys; json.dump(json.loads(sys.stdin.read()), sys.stdout, indent=2); sys.stdout.write('\n')" <<< "$content" 2>/dev/null
		exit_code=$?
	else
		python3 -c "import json, sys; json.loads(sys.stdin.read())" <<< "$content" 2>/dev/null
		exit_code=$?
	fi
else
	# Fallback: try with jq if available
	if command -v jq &>/dev/null; then
		if [[ "$pretty" == "true" ]]; then
			echo "$content" | jq . 2>/dev/null
			exit_code=$?
		else
			echo "$content" | jq empty 2>/dev/null
			exit_code=$?
		fi
	else
		if [[ ! "$quiet" == "true" ]]; then
			echo "is_json: python3 and jq not found" >&2
		fi
		exit 1
	fi
fi

if [[ $exit_code -ne 0 ]]; then
	if [[ ! "$quiet" == "true" ]]; then
		echo "is_json: invalid JSON" >&2
	fi
	exit 1
fi

exit 0
