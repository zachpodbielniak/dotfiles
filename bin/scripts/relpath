#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
relpath - Get relative path between two paths

USAGE:
	relpath [OPTIONS] <path> <basepath>

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information

EXAMPLES:
	relpath /home/user/docs/file.txt /home/user
	relpath /var/log/app.log /var

EOF
}

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		*) break ;;
	esac
done

if [[ $# -ne 2 ]]; then
	echo "Error: requires 2 arguments (path and basepath)" >&2
	exit 1
fi

path="${1}"
basepath="${2}"

# Resolve to absolute paths
path="$(cd "$(dirname "$path")" && pwd)/$(basename "$path")"
basepath="$(cd "$basepath" && pwd)"

# Find common prefix
common=""
path_parts=(${path//\// })
base_parts=(${basepath//\// })

for ((i = 0; i < ${#path_parts[@]} && i < ${#base_parts[@]}; i++)); do
	if [[ "${path_parts[$i]}" == "${base_parts[$i]}" ]]; then
		if [[ -z "$common" ]]; then
			common="${path_parts[$i]}"
		else
			common="${common}/${path_parts[$i]}"
		fi
	else
		break
	fi
done

# Count how many levels up we need to go
up_count=$((${#base_parts[@]} - $(echo "$common" | tr '/' '\n' | grep -c . || echo 0)))

# Build relative path
rel=""
for ((i = 0; i < up_count; i++)); do
	rel="../$rel"
done

# Add remaining path
remaining_path="${path#"$common"}"
remaining_path="${remaining_path#/}"

if [[ -z "$remaining_path" ]]; then
	if [[ -z "$rel" ]]; then
		echo "."
	else
		echo "${rel%/}"
	fi
else
	echo "${rel}${remaining_path}"
fi
