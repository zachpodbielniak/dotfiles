#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Check for alternative calc binary and re-exec if found
script_path="$(realpath "${BASH_SOURCE[0]}")"
while IFS= read -r calc_bin; do
	if [[ "$(realpath "$calc_bin")" != "$script_path" ]]; then
		exec "$calc_bin" "$@"
	fi
done < <(which -a calc 2>/dev/null)

usage () {
	cat << 'EOF'
calc - Simple calculator for mathematical expressions

USAGE:
	calc [OPTIONS]

OPTIONS:
	-h, --help          Show this help message
	--license           Show license information
	-p, --precision N   Decimal precision (default: 6)

EXAMPLES:
	echo "2 + 2" | calc
	echo "6 * 7" | calc
	echo "sqrt(16)" | calc
	echo "1 / 3" | calc -p 2

DESCRIPTION:
	Evaluates mathematical expressions from stdin.
	Supports: +, -, *, /, %, ^, sqrt(), sin(), cos(), tan(), log(), ln()

EOF
}

precision=6

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		-p|--precision)
			precision="$2"
			shift 2
			;;
		*)
			echo "calc: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Use bc for calculation (with math library)
while IFS= read -r line || [[ -n "$line" ]]; do
	[[ -z "$line" ]] && continue
	# Convert ^ to ** for bc, and add math library functions
	expr="$line"
	expr="${expr//\^/**}"

	# Use bc with math library
	if command -v bc &>/dev/null; then
		echo "scale=$precision; $expr" | bc -l 2>/dev/null || echo "calc: invalid expression: $line" >&2
	else
		echo "calc: bc not found" >&2
		exit 1
	fi
done
