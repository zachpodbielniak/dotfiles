#!/bin/bash

set -euo pipefail

usage() {
	cat << 'EOF'
retry_command - Retry command with exponential backoff

USAGE: retry_command [OPTIONS] COMMAND [ARGS...]

OPTIONS:
-h, --help      Show help
--license       License
-r N            Max retries (default: 3)
-d DELAY        Initial delay in seconds (default: 1)

EXAMPLES:
retry_command curl https://example.com
retry_command -r 5 -d 2 some_command arg1 arg2
EOF
}

[[ "${1:-}" == "-h" || "${1:-}" == "--help" ]] && { usage; exit 0; }
[[ "${1:-}" == "--license" ]] && { echo "AGPLv3"; exit 0; }

max_retries=3
delay=1

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-r) max_retries="${2}"; shift 2 ;;
		-d) delay="${2}"; shift 2 ;;
		-*) shift ;;
		*) break ;;
	esac
done

cmd="${1:-}"
[[ -z "$cmd" ]] && { echo "retry_command: COMMAND required" >&2; exit 1; }
shift

# Retry with exponential backoff
attempt=0
while [[ $attempt -le $max_retries ]]; do
	if "$cmd" "$@"; then
		exit 0
	fi
	if [[ $attempt -lt $max_retries ]]; then
		echo "Attempt $((attempt + 1)) failed, retrying in ${delay}s..." >&2
		sleep "$delay"
		delay=$((delay * 2))
	fi
	((attempt++))
done

echo "Command failed after $max_retries retries" >&2
exit 1
