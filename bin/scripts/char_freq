#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
char_freq - Character frequency analysis

USAGE:
	char_freq [OPTIONS]

OPTIONS:
	-h, --help             Show this help message
	--license              Show license information
	--top N                Show top N most frequent
	--ignore-whitespace    Don't count whitespace
	--ignore-case          Treat upper/lower as same
	--sort type            Sort by freq (default) or char

EXAMPLES:
	echo "aab" | char_freq
	echo "Hello" | char_freq --ignore-case
	echo "test" | char_freq --top 2

DESCRIPTION:
	Analyze character frequency distribution.

EOF
}

top=0
ignore_ws=false
ignore_case=false
sort_by="freq"

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--top)
			top="$2"
			shift 2
			;;
		--ignore-whitespace)
			ignore_ws=true
			shift
			;;
		--ignore-case)
			ignore_case=true
			shift
			;;
		--sort)
			sort_by="$2"
			shift 2
			;;
		*)
			echo "char_freq: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Use grep and awk to count character frequencies
awk -v top="$top" -v ignore_ws="$ignore_ws" -v ignore_case="$ignore_case" -v sort_type="$sort_by" '
	{
		if (ignore_case) {
			$0 = tolower($0)
		}
		for (i=1; i<=length($0); i++) {
			ch = substr($0, i, 1)
			if (ignore_ws && (ch ~ /^[ \t\n]$/)) {
				continue
			}
			count[ch]++
			total++
		}
	}
	END {
		n = 0
		for (ch in count) {
			chars[++n] = ch
		}

		# Sort
		for (i = 1; i <= n; i++) {
			for (j = i+1; j <= n; j++) {
				if (sort_type == "freq") {
					cmp = (count[chars[i]] < count[chars[j]])
				} else {
					cmp = (chars[i] > chars[j])
				}
				if (cmp) {
					tmp = chars[i]
					chars[i] = chars[j]
					chars[j] = tmp
				}
			}
		}

		limit = (top > 0 && top < n) ? top : n
		for (i = 1; i <= limit; i++) {
			printf "%s\t%d\n", chars[i], count[chars[i]]
		}
	}
'
