#!/bin/bash
set -euo pipefail

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

readonly PICTURES_DIR="${HOME}/Pictures"
declare -A ALBUM_BACKUPS=(
    [fold_5]="${PICTURES_DIR}/Fold_5"
    [s22_ultra]="${PICTURES_DIR}/S22_Ultra/"
    [lg_velvet]="${PICTURES_DIR}/LG_Velvet/"
    [bv8000pro]="${PICTURES_DIR}/Blackview_BV8000Pro/"
    [asus_z00ad]="${PICTURES_DIR}/Asus_ASUS_Z00AD/"
    [immutablue]="${PICTURES_DIR}/Immutablue/"
    [wallpapers]="${PICTURES_DIR}/LinuxWallpapers/ ${PICTURES_DIR}/Wallpapers/ ${PICTURES_DIR}/Backgrounds/"
)

# Global tracking variables
DRY_RUN=0
VERBOSE=0
RECURSIVE=1
declare -a SELECTED_ALBUMS=()
declare -a EXCLUDED_ALBUMS=()
ALBUMS_PROCESSED=0
ALBUMS_FAILED=0
FAILED_ALBUMS=()

show_help () {
    cat << 'EOF'
immich_sync - Synchronize photo albums to Immich

USAGE:
    immich_sync [OPTIONS]

OPTIONS:
    -h, --help              Show this help message
    -l, --list-albums       List all configured albums and their paths
    --license               Show license information
    --album <name>          Sync only specified album(s) (can be used multiple times)
    --exclude <name>        Exclude specified album(s) from sync (can be used multiple times)
    --dry-run               Show what would be synced without uploading
    --no-recursive          Don't use recursive flag for uploads
    --verbose               Show detailed output

EXAMPLES:
    # Sync all albums
    immich_sync

    # List available albums
    immich_sync --list-albums

    # Sync only specific albums
    immich_sync --album fold_5 --album s22_ultra

    # Dry run to preview changes
    immich_sync --dry-run

    # Verbose output
    immich_sync --verbose

EOF
}

show_license () {
    cat << 'EOF'
dotfiles - Personal configuration files and scripts
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.

EOF
}

list_albums () {
    echo "Configured Albums:"
    echo "=================="

    for album in $(printf '%s\n' "${!ALBUM_BACKUPS[@]}" | sort)
    do
        echo ""
        echo "Album: ${album}"
        echo "  Paths: ${ALBUM_BACKUPS[${album}]}"
    done

    echo ""
}

validate_dependencies () {
    if ! command -v immich &> /dev/null
    then
        echo "ERROR: 'immich' command not found in PATH. Please ensure immich CLI is installed and available. Can be installed with:"
        echo "  npm i -g @immich/cli"
        exit 1
    fi
}

validate_directory () {
    local directory="${1}"

    if [[ ! -d "${directory}" ]]
    then
        echo "WARNING: Directory does not exist: ${directory}"
        return 1
    fi

    return 0
}

sync_album () {
    local album="${1}"
    local paths="${2}"
    local timestamp

    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"

    if [[ "${VERBOSE}" -eq 1 ]]
    then
        echo "[${timestamp}] Processing album: ${album}"
        echo "[${timestamp}] Paths: ${paths}"
    else
        echo "Processing ${album}..."
    fi

    # Validate that at least one directory exists for this album
    local dir_found=0
    for dir in ${paths}
    do
        if validate_directory "${dir}"
        then
            dir_found=1
            break
        fi
    done

    if [[ ${dir_found} -eq 0 ]]
    then
        echo "ERROR: No valid directories found for album '${album}'"
        ALBUMS_FAILED=$((ALBUMS_FAILED + 1))
        FAILED_ALBUMS+=("${album}")
        return 1
    fi

    # Build the immich upload command
    local cmd="immich upload --album ${album}"

    if [[ ${RECURSIVE} -eq 1 ]]
    then
        cmd="${cmd} --recursive"
    fi

    cmd="${cmd} ${paths}"

    if [[ "${DRY_RUN}" -eq 1 ]]
    then
        echo "[DRY RUN] Would execute: ${cmd}"
        ALBUMS_PROCESSED=$((ALBUMS_PROCESSED + 1))
        return 0
    fi

    # Execute the upload command
    if ${cmd}
    then
        if [[ "${VERBOSE}" -eq 1 ]]
        then
            echo "[${timestamp}] Successfully processed ${album}"
        fi
        echo "-----------------------------------------------"
        ALBUMS_PROCESSED=$((ALBUMS_PROCESSED + 1))
        return 0
    else
        echo "ERROR: Failed to process album '${album}'"
        ALBUMS_FAILED=$((ALBUMS_FAILED + 1))
        FAILED_ALBUMS+=("${album}")
        echo "-----------------------------------------------"
        return 1
    fi
}

main () {
    if [[ ${#SELECTED_ALBUMS[@]} -gt 0 ]]
    then
        # Sync only selected albums
        for album in "${SELECTED_ALBUMS[@]}"
        do
            # Check if album is excluded
            local is_excluded=0
            for excluded in "${EXCLUDED_ALBUMS[@]}"
            do
                if [[ "${album}" == "${excluded}" ]]
                then
                    is_excluded=1
                    break
                fi
            done

            if [[ ${is_excluded} -eq 0 ]] && [[ -v ALBUM_BACKUPS[${album}] ]]
            then
                sync_album "${album}" "${ALBUM_BACKUPS[${album}]}" || true
            elif [[ ${is_excluded} -eq 1 ]]
            then
                echo "Skipping excluded album: ${album}"
            else
                echo "ERROR: Unknown album: ${album}"
                return 1
            fi
        done
    else
        # Sync all albums except excluded ones
        for album in $(printf '%s\n' "${!ALBUM_BACKUPS[@]}" | sort)
        do
            # Check if album is excluded
            local is_excluded=0
            for excluded in "${EXCLUDED_ALBUMS[@]}"
            do
                if [[ "${album}" == "${excluded}" ]]
                then
                    is_excluded=1
                    break
                fi
            done

            if [[ ${is_excluded} -eq 0 ]]
            then
                sync_album "${album}" "${ALBUM_BACKUPS[${album}]}" || true
            else
                echo "Skipping excluded album: ${album}"
            fi
        done
    fi

    # Print summary
    local timestamp
    timestamp="$(date '+%Y-%m-%d %H:%M:%S')"

    echo ""
    echo "=========================================="
    echo "Sync Summary - ${timestamp}"
    echo "=========================================="
    echo "Albums processed: ${ALBUMS_PROCESSED}"
    echo "Albums failed: ${ALBUMS_FAILED}"

    if [[ ${ALBUMS_FAILED} -gt 0 ]]
    then
        echo ""
        echo "Failed albums:"
        for album in "${FAILED_ALBUMS[@]}"
        do
            echo "  - ${album}"
        done
    fi

    echo ""

    # Exit with appropriate code
    if [[ ${ALBUMS_FAILED} -gt 0 ]]
    then
        return 1
    fi
}

# Parse command line arguments
while [[ $# -gt 0 ]]
do
    case "${1}" in
        -h|--help)
            show_help
            exit 0
            ;;
        -l|--list-albums)
            list_albums
            exit 0
            ;;
        --license)
            show_license
            exit 0
            ;;
        --album)
            if [[ -z "${2:-}" ]]
            then
                echo "ERROR: --album requires an argument"
                echo "See --help for usage information"
                exit 1
            fi
            SELECTED_ALBUMS+=("${2}")
            shift 2
            ;;
        --exclude)
            if [[ -z "${2:-}" ]]
            then
                echo "ERROR: --exclude requires an argument"
                echo "See --help for usage information"
                exit 1
            fi
            EXCLUDED_ALBUMS+=("${2}")
            shift 2
            ;;
        --dry-run)
            DRY_RUN=1
            shift
            ;;
        --no-recursive)
            RECURSIVE=0
            shift
            ;;
        --verbose)
            VERBOSE=1
            shift
            ;;
        *)
            echo "ERROR: Unknown option: ${1}"
            echo "See --help for usage information"
            exit 1
            ;;
    esac
done

# Validate dependencies before proceeding
validate_dependencies

# Run main sync logic
main

