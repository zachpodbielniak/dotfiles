#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Function to display usage
usage() {
    echo "Usage: $(basename "$0") [-h|--help] [-a|--all] [-s|--sudo]"
    echo ""
    echo "Display disk temperatures using smartctl"
    echo ""
    echo "Options:"
    echo "  -h, --help    Show this help message"
    echo "  -a, --all     Show all disks including those without temperature data"
    echo "  -s, --sudo    Use sudo for smartctl commands"
    exit 0
}

# Parse arguments
SHOW_ALL=false
USE_SUDO=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        -a|--all)
            SHOW_ALL=true
            shift
            ;;
        -s|--sudo)
            USE_SUDO="sudo"
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            usage
            ;;
    esac
done

# Check permissions
if [[ -z "$USE_SUDO" ]] && [[ $EUID -ne 0 ]]; then
    echo "This script requires root privileges. Please run with sudo or use -s flag." >&2
    exit 1
fi

# Check if smartctl is installed
if ! command -v smartctl &> /dev/null; then
    echo "Error: smartctl is not installed. Please install smartmontools package." >&2
    exit 1
fi

# Header
printf "%-12s %-20s %-12s %-40s\n" "Device" "Serial Number" "Current °C" "Model"
printf "%s\n" "$(printf '%.0s-' {1..88})"

# Get all disk devices
for device in $(lsblk -d -n -o NAME,TYPE | grep disk | grep -v zram | awk '{print "/dev/"$1}'); do
    [[ -e "$device" ]] || continue
    
    # Get SMART data
    smart_output=$($USE_SUDO smartctl -a "$device" 2>/dev/null) || continue
    [[ -n "$smart_output" ]] || continue
    
    # Get serial number
    serial=$(echo "$smart_output" | grep -i "Serial Number:" | awk '{print $3}' | head -1)
    [[ -n "$serial" ]] || serial="Unknown"
    
    # Get model
    model=$(echo "$smart_output" | grep -i "Device Model:\|Model Number:" | sed 's/.*: *//' | head -1)
    [[ -n "$model" ]] || model="Unknown"
    if [[ ${#model} -gt 40 ]]; then
        model="${model:0:37}..."
    fi
    
    # Get temperature
    temp=""
    if [[ "$device" == /dev/nvme* ]]; then
        # NVMe devices
        temp=$(echo "$smart_output" | grep -i "^Temperature:" | awk '{print $2}')
    else
        # SATA/SAS devices - look for temperature attributes
        temp=$(echo "$smart_output" | grep -E "^194 |^190 " | awk '{print $10}' | head -1)
    fi
    
    # Display results
    if [[ -n "$temp" ]] || [[ "$SHOW_ALL" == "true" ]]; then
        [[ -z "$temp" ]] && temp="N/A"
        
        # Color code temperatures
        if [[ "$temp" != "N/A" ]]; then
            if [[ "$temp" -ge 60 ]]; then
                temp_display="\033[31m$temp\033[0m"  # Red for hot
            elif [[ "$temp" -ge 50 ]]; then
                temp_display="\033[33m$temp\033[0m"  # Yellow for warm
            else
                temp_display="\033[32m$temp\033[0m"  # Green for cool
            fi
        else
            temp_display="$temp"
        fi
        
        printf "%-12s %-20s %-20b %-40s\n" "$device" "$serial" "$temp_display" "$model"
    fi
done

echo ""
printf "Temperature colors: \033[32m<50°C\033[0m \033[33m50-59°C\033[0m \033[31m≥60°C\033[0m\n"