#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
ngrams - Extract n-grams from text

USAGE:
	ngrams [OPTIONS] N

ARGUMENTS:
	N          N-gram size (e.g., 2 for bigrams, 3 for trigrams)

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--words         Word-level n-grams (default)
	--chars         Character-level n-grams
	--count         Include frequency count
	--unique        Only unique n-grams

EXAMPLES:
	echo "the quick brown fox" | ngrams 2
	echo "hello world" | ngrams --chars 2
	echo "a b c d" | ngrams 2 --count

DESCRIPTION:
	Extract n-grams (sequences of n elements) from input.

EOF
}

if [[ $# -lt 1 ]]; then
	usage >&2
	exit 1
fi

n=0
level="words"
show_count=false
unique_only=false

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--words)
			level="words"
			shift
			;;
		--chars)
			level="chars"
			shift
			;;
		--count)
			show_count=true
			shift
			;;
		--unique)
			unique_only=true
			shift
			;;
		[0-9]*)
			n="$1"
			shift
			;;
		*)
			echo "ngrams: unknown option: $1" >&2
			exit 1
			;;
	esac
done

if [[ $n -lt 1 ]]; then
	echo "ngrams: n must be >= 1" >&2
	exit 1
fi

# Process based on type
if [[ "$level" == "chars" ]]; then
	# Character-level n-grams
	grep -o . | awk -v n="$n" -v show_count="$show_count" -v unique="$unique_only" '
		{
			ngram = ngram $0
			if (length(ngram) > n) {
				ngram = substr(ngram, length(ngram) - n + 1)
			}
			if (length(ngram) == n) {
				count[ngram]++
			}
		}
		END {
			if (show_count || unique) {
				for (g in count) {
					print g "\t" count[g]
				}
			} else {
				for (g in count) {
					print g
				}
			}
		}
	'
else
	# Word-level n-grams
	awk -v n="$n" -v show_count="$show_count" -v unique="$unique_only" '
		{
			for (i=1; i<=NF; i++) {
				words[++total] = $i
			}
		}
		END {
			for (i=1; i<=total-n+1; i++) {
				ngram = words[i]
				for (j=1; j<n; j++) {
					ngram = ngram " " words[i+j]
				}
				if (show_count || unique) {
					count[ngram]++
				} else {
					print ngram
				}
			}
			if (show_count || unique) {
				for (g in count) {
					print g "\t" count[g]
				}
			}
		}
	'
fi
