#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

SCRIPT_NAME="$(basename "${0}")"

usage () {
    cat <<EOF
${SCRIPT_NAME} - Reformat rough text into clean markdown

USAGE:
    ${SCRIPT_NAME} [OPTIONS] [FILE]

DESCRIPTION:
    Reformats rough text into clean, properly structured markdown using AI.
    Reads from stdin by default, or from a file if provided.

    Useful for cleaning up copy-pasted notes, fixing formatting issues,
    and adding proper markdown structure (headers, lists, code blocks).

OPTIONS:
    -h, --help      Show this help message and exit
    --license       Show the license (AGPLv3) and exit

ARGUMENTS:
    FILE            Optional file path to read content from.
                    If not provided, reads from stdin.

EXAMPLES:
    # Pipe rough notes through stdin
    echo "rough notes here
    - item 1
    - item2
    some more stuff" | ${SCRIPT_NAME}

    # Read from a file
    ${SCRIPT_NAME} /tmp/rough_notes.txt

    # Use in neovim (visual selection -> filter)
    :'<,'>!${SCRIPT_NAME}

    # Clean up clipboard content
    xclip -selection clipboard -o | ${SCRIPT_NAME}

EOF
}

show_license () {
    cat <<EOF
${SCRIPT_NAME} - Reformat rough text into clean markdown
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

main () {
    local file_path=""
    local content=""

    # Parse arguments
    while [[ $# -gt 0 ]]
    do
        case "${1}" in
            -h|--help)
                usage
                exit 0
                ;;
            --license)
                show_license
                exit 0
                ;;
            -*)
                echo "Error: Unknown option '${1}'" >&2
                echo "Use '${SCRIPT_NAME} --help' for usage information." >&2
                exit 1
                ;;
            *)
                # Positional argument is the file path
                if [[ -n "${file_path}" ]]
                then
                    echo "Error: Only one file path can be provided." >&2
                    exit 1
                fi
                file_path="${1}"
                ;;
        esac
        shift
    done

    # Read content from file or stdin
    if [[ -n "${file_path}" ]]
    then
        if [[ ! -f "${file_path}" ]]
        then
            echo "Error: File '${file_path}' not found." >&2
            exit 1
        fi
        content=$(cat "${file_path}")
    else
        content=$(cat)
    fi

    # Check if we have any content
    if [[ -z "${content}" ]]
    then
        echo "Error: No content provided." >&2
        exit 1
    fi

    # Pipe content through aipy for markdown formatting
    echo "${content}" | aipy --no-preserve --hide-model "Reformat this text into clean, well-structured markdown. Preserve the original meaning and content exactly. Add proper markdown structure where appropriate (headers, lists, code blocks, emphasis). Fix whitespace and formatting issues. Do not add any commentary, explanations, or extra content. Output only the reformatted markdown."
}

main "$@"
