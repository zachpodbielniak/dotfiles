#!/bin/bash 
set -euo pipefail

# Global arrays
files_in=()
files_out=()
command_in=()


# Get all the files either from 
# stdin or the args
if [[ $# -lt 1 ]]; then 
    while IFS= read -r line 
    do 
        files_in+=("$line")
    done
else 
    for file in "$@"
    do 
        files_in+=("$file")
    done
fi


# Get file name tweaks
while IFS= read -r line 
do 
    files_out+=("$line")
done < <(vipe < <(for file in "${files_in[@]}"; do echo "$file"; done))


# Validate lengths match -- if not bail out
length_in="${#files_in[@]}"
length_out="${#files_out[@]}"
if [[ "$length_in" != "$length_out" ]]; then 
    echo "Array size is not the same! Did you accidentally delete an entry?"
    echo "Input: $length_in"
    echo "Output: $length_out"
    exit 1 
fi


# Build first line of script
command_in+=("#!/bin/bash")
command_in+=("# Confirm by commenting out below line")
command_in+=("exit 255")


# Generate mv commands
index=0
for file in "${files_out[@]}"
do 
    command_in+=("mv -iv '${files_in[$index]}' '$file'")
    ((index++))
done


# Validate command and 
# Perform the actual output
bash < <(vipe --suffix sh < <(for cmd in "${command_in[@]}"; do echo "$cmd"; done))


