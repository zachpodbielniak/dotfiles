#!/bin/bash
set -e

# batch: Run a command in parallel on multiple files
# Usage: batch NJOBS COMMAND [ARGS...] -- FILE1 FILE2 ...

function show_help() {
    echo "Usage: batch NJOBS COMMAND [ARGS...] -- FILE1 FILE2 ..."
    echo
    echo "Run a command in parallel on multiple files, with a maximum number of jobs."
    echo
    echo "Arguments:"
    echo "  NJOBS     Maximum number of jobs to run in parallel"
    echo "  COMMAND   The command to run"
    echo "  ARGS      Arguments to pass to the command (before the file)"
    echo "  --        Separator between command arguments and file list"
    echo "  FILE1...  Files to process (one per job)"
    echo
    echo "Example:"
    echo "  batch 4 convert -resize 800x600 -- *.jpg"
    echo "  # Runs 'convert -resize 800x600 FILE' for each jpg, 4 at a time"
    echo
    echo "Options:"
    echo "  -h, --help    Display this help message and exit"
}

# Parse help option
if [[ $# -eq 0 || "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Check for minimum required arguments
if [[ $# -lt 4 ]]; then
    echo "Error: Not enough arguments provided" >&2
    show_help
    exit 1
fi

# Parse number of jobs
if ! [[ "$1" =~ ^[0-9]+$ ]]; then
    echo "Error: NJOBS must be a positive integer" >&2
    exit 1
fi
njobs=$1
shift

# Extract the command
command="$1"
shift

# Extract command arguments and files
cmd_args=()
files=()
found_separator=false

for arg in "$@"; do
    if [[ "$arg" == "--" && "$found_separator" == "false" ]]; then
        found_separator=true
    elif [[ "$found_separator" == "true" ]]; then
        files+=("$arg")
    else
        cmd_args+=("$arg")
    fi
done

# Check if separator was found
if [[ "$found_separator" == "false" ]]; then
    echo "Error: Missing separator '--' between command arguments and files" >&2
    show_help
    exit 1
fi

# Check if we have any files
if [[ ${#files[@]} -eq 0 ]]; then
    echo "Error: No files provided" >&2
    show_help
    exit 1
fi

# Process files in batches
total_files=${#files[@]}
echo "Starting batch processing with $njobs parallel jobs for $total_files files..."

# Process files in batches of $njobs
for ((i=0; i<${#files[@]}; i+=$njobs)); do
    # Array to store PIDs
    pids=()
    
    # Start a batch of jobs
    for ((j=i; j<i+$njobs && j<${#files[@]}; j++)); do
        file="${files[$j]}"
        echo "Starting job: $command ${cmd_args[*]} $file"
        "$command" "${cmd_args[@]}" "$file" &
        pids+=($!)
    done
    
    # Wait for all jobs in this batch to complete
    for pid in "${pids[@]}"; do
        wait $pid
    done
done

echo "All jobs completed."