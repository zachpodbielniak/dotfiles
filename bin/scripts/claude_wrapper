#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# claude_wrapper - Claude Code wrapper that syncs sessions to database after exit
#
# Usage: claude_wrapper [claude args...]
#
# Examples:
#   claude_wrapper                    # Start claude in current directory
#   claude_wrapper --resume           # Resume last session
#   claude_wrapper -p "fix the bug"   # Start with a prompt
#   claude_wrapper --verbose          # Run in verbose mode
#
# This wrapper runs claude with any provided arguments, then syncs
# the session data to the local PostgreSQL database when claude exits.

set -euo pipefail

# Hostnames where database sync is enabled
# Add new hostnames to this array as needed
SYNC_HOSTNAMES=(
    "lt-zach"
    "srv-zach"
)

# Arguments that should skip sync (no session created)
SKIP_SYNC_ARGS=(
    "--help"
    "-h"
    "--version"
    "mcp"
    "plugin"
    "setup-token"
    "update"
    "install"
    "doctor"
)

# Check if current hostname is in the allowed list
is_sync_enabled () {
    local current_host
    current_host="$(hostname)"

    for allowed_host in "${SYNC_HOSTNAMES[@]}"
    do
        if [[ "${current_host}" == "${allowed_host}" ]]
        then
            return 0
        fi
    done
    return 1
}

# Check if any argument should skip sync
should_skip_sync () {
    for arg in "$@"
    do
        for skip_arg in "${SKIP_SYNC_ARGS[@]}"
        do
            if [[ "${arg}" == "${skip_arg}" ]]
            then
                return 0
            fi
        done
    done
    return 1
}

# Run claude with all arguments passed through
claude "$@"
exit_code=$?

# Sync sessions to database after claude exits (only on allowed hosts, skip for help/version)
if ! should_skip_sync "$@" && is_sync_enabled && command -v claude_code_db_sync &>/dev/null
then
    claude_code_db_sync --scan &>/dev/null
fi

exit ${exit_code}
