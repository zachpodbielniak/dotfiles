#!/bin/bash 
set -euo pipefail


input=""
limit=5
provider="grokpy"
sanitize="false"
dry_run="false"
child_args=()



print_help() {
    echo -e "Usage: $(basename) <args>"
    echo -e "  -h,--help\tshow this message"
    echo -e "  -p,--prompt\tset the prompt (in addition to stdin if passed)"
    echo -e "  --provider\twhich ai provider to use (claudpy, grokpy, perpy, ollampy, geminpy, openpy)"
    echo -e "  --limit\tset the limit for search with semantic_search (default: 5)"
    echo -e "  --sanitize\tpass data through the data sanitizer before passing off to the provider"
}


while [[ $# -gt 0 ]]
do 
    case "${1}" in 
    -h|--help)
        print_help
        exit 0
        ;;
    -p|--prompt)
        input="${2}"
        shift
        ;;
    --provider)
        provider="${1}"
        ;;
    --limit)
        limit="${1}"
        ;;
    --sanitize)
        sanitize="true"
        ;;
    --dry-run)
        dry_run="true"
        ;;
    *)
        child_args+=("${1}")
        ;;
    esac
    shift
done

# process stdin and append to input
while read -r line 
do 
    printf -v input "%s%s\n" "${input}" "${line}"
done

# get the stuff that maps
files=$(semantic_search --limit "${limit}" --simple --full-path "${input}")

# separate content and modify input after we did our initial search
printf -v input "%s\n-------------------------------\n" "${input}"
printf -v input "%sanswer the question above, given only the information below.\n" "${input}" 
printf -v input "%ssome of the content may be relevant, and some not.\n" "${input}"
printf -v input "%srespond only in markdown format.\n" "${input}"
printf -v input "%s\n-------------------------------\n" "${input}"

# iterate all files and cat them 
for f in ${files}
do 
    input=$(cat <(cat <<< "${input}") "${f}")
done

if [[ "true" == "${sanitize}" ]]
then 
    input=$(sanitize_data <<< "${input}")
fi

if [[ "true" == "${dry_run}" ]]
then 
    cat <<< "${input}"
else
    ${provider} ${child_args[@]} <<< "${input}"
fi

