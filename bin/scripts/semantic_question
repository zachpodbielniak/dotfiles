#!/bin/bash 
set -euo pipefail


input=""
limit=5
provider="grokpy"
child_args=()



print_help() {
    echo -e "Usage: $(basename) <args>"
    echo -e "  -h,--help\tshow this message"
}


while [[ $# -gt 0 ]]
do 
    case "${1}" in 
    -h|--help)
        print_help
        exit 0
        ;;
    -p|--prompt)
        input="${2}"
        shift
        ;;
    --provider)
        provider="${1}"
        ;;
    --limit)
        limit="${1}"
        ;;
    *)
        child_args+=("${1}")
        ;;
    esac
    shift
done

# process stdin and append to input
while read -r line 
do 
    printf -v input "%s%s\n" "${input}" "${line}"
done

# get the stuff that maps
files=$(semantic_search --limit "${limit}" --simple --full-path "${input}")

# separate content and modify input after we did our initial search
printf -v input "%s\n-------------------------------\n" "${input}"
printf -v input "%sanswer the question above, given only the information below.\n" "${input}" 
printf -v input "%ssome of the content may be relevant, and some not.\n" "${input}"
printf -v input "%srespond only in markdown format.\n" "${input}"
printf -v input "%s\n-------------------------------\n" "${input}"

# iterate all files and cat them 
for f in ${files}
do 
    input=$(cat <(cat <<< "${input}") "${f}")
done

${provider} ${child_args[@]} <<< "${input}"

