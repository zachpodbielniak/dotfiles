#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
is_url - Validate if lines are valid URLs

USAGE:
	is_url [OPTIONS]

OPTIONS:
	-h, --help        Show this help message
	--license         Show license information
	--quiet           No output, just exit code
	--http-only       Only accept http/https URLs
	--check           Verify URL is reachable (HTTP HEAD request)

EXAMPLES:
	echo "https://example.com" | is_url && echo "Valid URL"
	echo "ftp://example.com" | is_url --http-only || echo "FTP not allowed"
	echo "https://example.com" | is_url --check && echo "URL is reachable"

DESCRIPTION:
	Exit code 0 if ALL lines are valid URLs.
	Exit code 1 if ANY line is not a valid URL.

EOF
}

quiet=false
http_only=false
check=false

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--quiet)
			quiet=true
			shift
			;;
		--http-only)
			http_only=true
			shift
			;;
		--check)
			check=true
			shift
			;;
		*)
			if [[ ! "$quiet" == "true" ]]; then
				echo "is_url: unknown option: $1" >&2
			fi
			exit 1
			;;
	esac
done

# URL regex pattern: requires scheme, domain, etc.
# Basic pattern for URLs with schemes
url_pattern='^[a-zA-Z][a-zA-Z0-9+.-]*://[^[:space:]]+$'
http_pattern='^https?://[^[:space:]]+$'

all_valid=true

while IFS= read -r line || [[ -n "$line" ]]; do
	[[ -z "$line" ]] && continue

	is_valid=false

	if [[ "$http_only" == "true" ]]; then
		[[ "$line" =~ $http_pattern ]] && is_valid=true
	else
		[[ "$line" =~ $url_pattern ]] && is_valid=true
	fi

	if [[ "$is_valid" == "true" ]] && [[ "$check" == "true" ]]; then
		# Try to check if URL is reachable
		if command -v curl &>/dev/null; then
			if ! curl -s -o /dev/null -w '%{http_code}' --max-time 5 -I "$line" 2>/dev/null | grep -q '^[23]'; then
				is_valid=false
			fi
		fi
	fi

	if [[ "$is_valid" == "false" ]]; then
		all_valid=false
		if [[ ! "$quiet" == "true" ]]; then
			echo "is_url: invalid URL: $line" >&2
		fi
	fi
done

if [[ "$all_valid" == "true" ]]; then
	exit 0
else
	exit 1
fi
