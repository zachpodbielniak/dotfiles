#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

TRUE="1"
FALSE="0"

declare -a input_files
declare -a converted_files
status_file="./converted.txt"
output_dir="./output"
done_dir="./done"
preset="5"


print_help() {
    echo -e "Usage: $(basename ${0}) <args>"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -o,--output\tuse as output dir (default: ./output)"
    echo -e "  -p,--preset\tuse as preset (default: 5)"
    echo -e "  -s,--status\tstatus file (default: ./converted.txt"
    echo -e "  -d,--done\tdir to move files that are done (default: ./done)"
}


preload_status() {
    if [[ -f "${status_file}" ]]
    then
        while read -r line 
        do 
            converted_files+=("${line}")
        done < "${status_file}"
    fi
}


file_already_converted() {
    local f_to_check="$(basename "${1}")"
    for f in "${converted_files[@]}"
    do 
        if [[ "${f}" == "${f_to_check}" ]]
        then
            echo "${TRUE}"
            return
        fi
    done
    echo "${FALSE}"
}


determine_files_to_convert() {
    for f in ./*
    do 
        if [[ "${f}" == "${status_file}" ]] || [[ ! -f "${f}" ]]
        then 
            continue 
        fi

        if [[ "${FALSE}" == "$(file_already_converted "${f}")" ]]
        then 
            input_files+=("${f}")
        else 
            echo "info: following file is already converted, skipping: ${f}"
        fi
    done
}


convert_file() {
    local f_to_convert="${1}"
    echo "info: converting ${f_to_convert}"

    until ab-av1 auto-encode -i "${f_to_convert}" --preset "${preset}" -o "${output_dir}/${f_to_convert:0:-4}.mkv"
    do 
        local exit_status=$?
        echo "error: exit code of (${exit_status}) when attempting to convert ${f_to_convert}....retrying"
    done

    echo "${f_to_convert}" >> "${status_file}"
    mv "${f_to_convert}" "${done_dir}"
}


convert_all_files() {
    for f in "${input_files[@]}"
    do
        convert_file "${f}"
    done
}


while [[ $# -gt 0 ]]
do 
    case "${1}" in 
    -h|--help)
        print_help
        exit 0
        ;;
    -o|--output)
        output_dir="${2}"
        shift
        ;;
    -p|--preset)
        preset="${2}"
        shift
        ;;
    -s|--status)
        status_file="${2}"
        shift
        ;;
    -d|--done)
        done_dir="${2}"
        shift 
        ;;
    esac
    shift
done


mkdir -p "${output_dir}"
mkdir -p "${done_dir}"
preload_status
determine_files_to_convert
convert_all_files

