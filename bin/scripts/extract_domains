#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
extract_domains - Extract domain names from URLs or text

USAGE:
	extract_domains [OPTIONS]

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--root          Extract root domain only (example.com from sub.example.com)
	--unique        Deduplicate

EXAMPLES:
	echo "https://sub.example.com/path" | extract_domains
	echo "https://sub.example.com" | extract_domains --root
	cat urls.txt | extract_domains --unique

EOF
}

root_only=false
unique_only=false

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--root) root_only=true; shift ;;
		--unique) unique_only=true; shift ;;
		*) echo "Error: unexpected argument '$1'" >&2; exit 1 ;;
	esac
done

# Extract domains from URLs and text
extract_domain_from_line () {
	local line="$1"
	local domain=""

	# Try to extract domain from URL (with or without scheme)
	if [[ "$line" =~ https?://([^/?#]+) ]]; then
		domain="${BASH_REMATCH[1]}"
	elif [[ "$line" =~ ^([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})(/|$) ]]; then
		# Bare domain
		domain="${BASH_REMATCH[1]}"
	fi

	if [[ -n "$domain" ]]; then
		if [[ "$root_only" == true ]]; then
			# Extract root domain (last two parts before TLD)
			# This is a simple heuristic
			domain=$(echo "$domain" | sed 's/^.*\.\([^.]*\.[^.]*\)$/\1/')
		fi
		echo "$domain"
	fi
}

if [[ "$unique_only" == true ]]; then
	while IFS= read -r line; do
		extract_domain_from_line "$line"
	done | sort -u
else
	while IFS= read -r line; do
		extract_domain_from_line "$line"
	done
fi
