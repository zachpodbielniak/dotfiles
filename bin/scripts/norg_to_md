#!/usr/bin/env perl
use strict;
use warnings;


my $file_input = "";
my $file_output = "";

my $file_input_handle; 
my $file_output_handle;

my $in_code_snippet = 0;


sub print_help {
    print("norg_to_md:\n");
    print("  -h,--help\tprint this message\n");
    print("  -i,--input\tfile for input, by default stdin\n");
    print("  -o,--output\tfile for output, by default stdout\n");
    exit(0);
}


sub convert_line_to_md {
    my $line = $_;
    
    if ( $in_code_snippet == 0) {
        if ($line =~ /^\*{1,6}\ /) { # headings
            $line =~ s/\*/#/g;
            printf("%s", $line);
        } elsif ($line =~ /[\w\s-]{1,}\*/) { # bold
            $line =~ s/\*/\*\*/g;
            printf("%s", $line);
        } elsif ($line =~ /[\w\s-]{1,}\//) { # italic
            $line =~ s/\//_/g;
            printf("%s", $line);
        }  elsif ($line =~ /\s{0,}\@code\s(\w+)/) { # code snippet
            printf("%s", "```$1\n");
            $in_code_snippet = 1;
        }
    } else {
        if ($line =~ /\s{0,}\@end/) {
            printf("%s", "```\n");
            $in_code_snippet = 0;
        } else {
            printf("%s", $line);
        }
    }
}


sub process_input {
    while (<$file_input_handle>) {
        if ($_ eq "\n") {
            print("\n");
        } else {
            convert_line_to_md($_);
        }
    } 
}


while (my $arg = shift @ARGV) {
    if ("-h" eq $arg || "--help" eq $arg) {
        print_help();
    } elsif ("-i" eq $arg || "--input" eq $arg) {
        $file_input = shift @ARGV;
    } elsif ("-o" eq $arg || "--output" eq $arg) {
        $file_output = shift @ARGV;
    }
}

if ("" ne $file_input) {
    open($file_input_handle, "<", $file_input) or die $!;
} else {
}

if ("" ne $file_output) {
    open($file_output_handle, ">", $file_output) or die $1;
}



process_input();



if ("" ne $file_input) {
    close($file_input_handle);
}

if ("" ne $file_output) {
    close($file_output_handle);
}
