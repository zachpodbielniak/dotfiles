#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# =============================================================================
# mcpb_helper - Generate .MCPB bundles for Claude Desktop MCP servers
# =============================================================================

VERSION="1.0.0"
SCRIPT_NAME="$(basename "$0")"

# Temp directory for bundle creation
TEMP_DIR=""

# =============================================================================
# CLEANUP
# =============================================================================

cleanup () {
    if [[ -n "${TEMP_DIR}" ]] && [[ -d "${TEMP_DIR}" ]]
    then
        rm -rf "${TEMP_DIR}"
    fi
}

trap cleanup EXIT

# =============================================================================
# USAGE
# =============================================================================

usage () {
    cat <<EOF
${SCRIPT_NAME} - Generate .MCPB bundles for Claude Desktop

USAGE:
    ${SCRIPT_NAME} --<server> [-o <output.mcpb>]
    ${SCRIPT_NAME} --list
    ${SCRIPT_NAME} -h|--help

OPTIONS:
    --<server>      Generate bundle for specified server
    -o, --output    Output file path (default: <server>.mcpb in current dir)
    --list          List available server configurations
    -h, --help      Show this help message
    --license       Show license information
    --version       Show version

EXAMPLES:
    ${SCRIPT_NAME} --flashcards
    ${SCRIPT_NAME} --flashcards -o ~/Downloads/flashcards.mcpb
    ${SCRIPT_NAME} --list

AVAILABLE SERVERS:
    --flashcards    Spaced repetition flashcards with AI generation
    --vimban        Markdown-native ticket and kanban management

EOF
}

show_license () {
    cat <<EOF
mcpb_helper - Generate .MCPB bundles for Claude Desktop
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

list_servers () {
    cat <<EOF
Available MCP server configurations:

  flashcards      Spaced repetition flashcards with AI generation
                  Command: flashcards-serve --mcp

  vimban          Markdown-native ticket and kanban management
                  Command: vimban --mcp

To add more servers, edit the get_server_config function in this script.
EOF
}

# =============================================================================
# SERVER CONFIGURATIONS
# =============================================================================

# Sets global variables: SERVER_NAME, SERVER_VERSION, SERVER_DESCRIPTION, SERVER_COMMAND
# SERVER_COMMAND should be the base command, SERVER_ARGS the arguments
get_server_config () {
    local server="${1}"

    case "${server}" in
        flashcards)
            SERVER_NAME="flashcards"
            SERVER_VERSION="1.0.0"
            SERVER_DESCRIPTION="Spaced repetition flashcards with AI generation from notes"
            SERVER_COMMAND="flashcards-serve"
            SERVER_ARGS_RAW="--mcp"
            ;;
        vimban)
            SERVER_NAME="vimban"
            SERVER_VERSION="1.0.0"
            SERVER_DESCRIPTION="Markdown-native ticket and kanban management"
            SERVER_COMMAND="vimban"
            SERVER_ARGS_RAW="--mcp"
            ;;
        *)
            echo "Error: Unknown server '${server}'" >&2
            echo "Run '${SCRIPT_NAME} --list' to see available servers" >&2
            return 1
            ;;
    esac
}

# =============================================================================
# BUNDLE GENERATION
# =============================================================================

generate_manifest () {
    cat <<EOF
{
  "manifest_version": "0.1",
  "name": "${SERVER_NAME}",
  "version": "${SERVER_VERSION}",
  "description": "${SERVER_DESCRIPTION}",
  "author": {
    "name": "Zach Podbielniak"
  },
  "server": {
    "type": "binary",
    "entry_point": "run.sh",
    "mcp_config": {
      "command": "bash",
      "args": ["\${__dirname}/run.sh"]
    }
  }
}
EOF
}

generate_run_script () {
    cat <<EOF
#!/bin/bash
exec ${SERVER_COMMAND} ${SERVER_ARGS_RAW}
EOF
}

create_bundle () {
    local server="${1}"
    local output="${2}"

    # Get server configuration
    get_server_config "${server}"

    # Create temp directory
    TEMP_DIR="$(mktemp -d)"
    local bundle_dir="${TEMP_DIR}/${SERVER_NAME}"
    mkdir -p "${bundle_dir}"

    # Generate files
    generate_manifest > "${bundle_dir}/manifest.json"
    generate_run_script > "${bundle_dir}/run.sh"
    chmod +x "${bundle_dir}/run.sh"

    # Create ZIP bundle
    (
        cd "${bundle_dir}"
        zip -q -r "${TEMP_DIR}/${SERVER_NAME}.mcpb" manifest.json run.sh
    )

    # Move to output location
    mv "${TEMP_DIR}/${SERVER_NAME}.mcpb" "${output}"

    echo "Created: ${output}"
}

# =============================================================================
# MAIN
# =============================================================================

main () {
    local server=""
    local output=""

    if [[ $# -eq 0 ]]
    then
        usage
        exit 0
    fi

    while [[ $# -gt 0 ]]
    do
        case "${1}" in
            -h|--help)
                usage
                exit 0
                ;;
            --license)
                show_license
                exit 0
                ;;
            --version)
                echo "${SCRIPT_NAME} ${VERSION}"
                exit 0
                ;;
            --list)
                list_servers
                exit 0
                ;;
            -o|--output)
                if [[ $# -lt 2 ]]
                then
                    echo "Error: -o requires an argument" >&2
                    exit 1
                fi
                output="${2}"
                shift 2
                ;;
            --*)
                # Extract server name from --<server>
                server="${1#--}"
                shift
                ;;
            *)
                echo "Error: Unknown argument '${1}'" >&2
                usage >&2
                exit 1
                ;;
        esac
    done

    if [[ -z "${server}" ]]
    then
        echo "Error: No server specified" >&2
        echo "Run '${SCRIPT_NAME} --list' to see available servers" >&2
        exit 1
    fi

    # Default output path
    if [[ -z "${output}" ]]
    then
        output="${server}.mcpb"
    fi

    create_bundle "${server}" "${output}"
}

main "$@"
