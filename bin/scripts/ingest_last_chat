#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Default options
MODE="context"  # context or chat
DEBUG=0
DRY_RUN=0
SBI_ARGS=""

show_help() {
	cat << EOF
ingest_last_chat - Ingest the last AI chat/context into your second brain

USAGE:
	ingest_last_chat [OPTIONS]

OPTIONS:
	-h, --help              Show this help message
	-c, --context           Ingest last context (default)
	-C, --chat              Ingest last chat content only
	-d, --debug             Enable debug output
	--dry-run               Show what would be ingested without actually ingesting
	-s, --sbi-args ARGS     Pass additional arguments to sbi

EXAMPLES:
	# Ingest the last context
	ingest_last_chat

	# Ingest the last chat content
	ingest_last_chat --chat

	# Show what would be ingested without ingesting
	ingest_last_chat --dry-run

	# Pass custom name-seed to sbi
	ingest_last_chat --sbi-args "--name-seed 'my custom name'"

EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help)
			show_help
			exit 0
			;;
		-c|--context)
			MODE="context"
			shift
			;;
		-C|--chat)
			MODE="chat"
			shift
			;;
		-d|--debug)
			DEBUG=1
			shift
			;;
		--dry-run)
			DRY_RUN=1
			shift
			;;
		-s|--sbi-args)
			SBI_ARGS="${2}"
			shift 2
			;;
		*)
			echo "Error: Unknown option '${1}'" >&2
			show_help
			exit 1
			;;
	esac
done

# Validate that required tools are available
for tool in aipy sbi; do
	if ! command -v "${tool}" &>/dev/null; then
		echo "Error: Required tool '${tool}' not found in PATH" >&2
		exit 1
	fi
done

if [[ ${DEBUG} -eq 1 ]]; then
	echo "Debug: MODE=${MODE}" >&2
	echo "Debug: DRY_RUN=${DRY_RUN}" >&2
	echo "Debug: SBI_ARGS=${SBI_ARGS}" >&2
fi

# Get the UUID
if [[ "${MODE}" == "context" ]]; then
	UUID=$(aipy --last-context-uuid 2>/dev/null) || {
		echo "Error: Failed to get last context UUID" >&2
		exit 1
	}
	AIPY_ARGS=("--view-context" "${UUID}")
	DESCRIPTION="last context"
else
	UUID=$(aipy --last-chat-uuid 2>/dev/null) || {
		echo "Error: Failed to get last chat UUID" >&2
		exit 1
	}
	AIPY_ARGS=("--view" "${UUID}" "--content-only")
	DESCRIPTION="last chat"
fi

if [[ ${DEBUG} -eq 1 ]]; then
	echo "Debug: UUID=${UUID}" >&2
	echo "Debug: DESCRIPTION=${DESCRIPTION}" >&2
fi

# Build the pipeline
if [[ ${DRY_RUN} -eq 1 ]]; then
	echo "Would ingest the ${DESCRIPTION}:" >&2
	echo "---" >&2
	aipy "${AIPY_ARGS[@]}" 2>/dev/null | aipy --no-preserve --to-markdown 2>/dev/null
	echo "---" >&2
	echo "Run without --dry-run to ingest into sbi" >&2
else
	if [[ ${DEBUG} -eq 1 ]]; then
		echo "Debug: Ingesting ${DESCRIPTION} (UUID: ${UUID})" >&2
	fi

	# Ingest into sbi with any additional arguments
	# shellcheck disable=SC2086
	aipy "${AIPY_ARGS[@]}" 2>/dev/null | aipy --no-preserve --to-markdown 2>/dev/null | sbi ${SBI_ARGS}
fi

