#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Canary marker to prevent duplicate summaries (hidden in markdown comments)
CANARY='<!-- APPEND_SUMMARY_CANARY_7f3a9b2c -->'

# Default separator between content and summary (includes canary)
DEFAULT_SEPARATOR=$'\n---\n\n'"${CANARY}"$'\n\n## Summary\n\n'

show_help () {
	cat <<EOF
append_summary - Append AI-generated summary to content

USAGE:
    cat file.txt | append_summary [OPTIONS] [-- AI_OPTIONS...]
    append_summary -f FILE [OPTIONS] [-- AI_OPTIONS...]

DESCRIPTION:
    Appends an AI-generated summary to input content. Always outputs
    original content + separator + summary to stdout.

    With -f/--file, reads from the specified file instead of stdin.
    With --write-back, appends the summary directly to the file.

    A canary marker is included to prevent duplicate summaries. If the
    canary is detected in the input, the script exits without processing
    (use --force to override).

OPTIONS:
    -f, --file FILE     Read content from FILE instead of stdin
    -w, --write-back    Append summary to the file (requires -f)
    -s, --separator SEP Custom separator (default includes canary marker)
    --force             Bypass canary check and append anyway
    -h, --help          Show this help message
    --license           Show AGPLv3 license information

    All other options are forwarded to ai_summary_as_markdown.
    Common forwarded options include:
        --type TYPE         Content type (meeting, lecture, youtube, etc.)
        --reading-level LVL Target reading level (elementary, middle, high, etc.)
        --style STYLE       Tone (personal, academic, business, casual)
        --length LEN        Summary depth (brief, standard, detailed)

EXAMPLES:
    # Stdin mode (vim filter)
    cat meeting.txt | append_summary --type meeting

    # Vim :% filter
    :%!append_summary --type meeting

    # File mode (output to stdout)
    append_summary -f meeting.txt --type meeting

    # File mode with write-back (modifies the file)
    append_summary -f meeting.txt --write-back --type meeting

    # Force append even if summary already exists
    append_summary -f meeting.txt --force --type meeting

    # With additional options forwarded to ai_summary_as_markdown
    cat notes.txt | append_summary --type lecture --reading-level middle

EOF
}

show_license () {
	cat <<EOF
append_summary - Part of dotfiles
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

# Variables
file_path=""
write_back=false
force=false
separator="${DEFAULT_SEPARATOR}"
forward_args=()

# Parse arguments - separate our args from ai_summary_as_markdown args
while [[ $# -gt 0 ]]
do
	case "${1}" in
		-h|--help)
			show_help
			exit 0
			;;
		--license)
			show_license
			exit 0
			;;
		-f|--file)
			if [[ -z "${2:-}" ]]
			then
				echo "Error: --file requires a file path argument" >&2
				exit 1
			fi
			file_path="${2}"
			shift 2
			;;
		-w|--write-back)
			write_back=true
			shift
			;;
		--force)
			force=true
			shift
			;;
		-s|--separator)
			if [[ -z "${2:-}" ]]
			then
				echo "Error: --separator requires a separator string argument" >&2
				exit 1
			fi
			# Custom separator - prepend canary to it
			separator="${CANARY}"$'\n'"${2}"
			shift 2
			;;
		--)
			# Everything after -- goes to ai_summary_as_markdown
			shift
			forward_args+=("$@")
			break
			;;
		*)
			# Forward unknown args to ai_summary_as_markdown
			forward_args+=("${1}")
			shift
			;;
	esac
done

# Check that ai_summary_as_markdown is available
if ! command -v ai_summary_as_markdown &>/dev/null
then
	echo "Error: ai_summary_as_markdown not found in PATH" >&2
	exit 1
fi

# Validate --write-back requires --file
if [[ "${write_back}" == true ]] && [[ -z "${file_path}" ]]
then
	echo "Error: --write-back requires -f/--file to be specified" >&2
	exit 1
fi

# Read content from file or stdin
if [[ -n "${file_path}" ]]
then
	if [[ ! -f "${file_path}" ]]
	then
		echo "Error: File not found: ${file_path}" >&2
		exit 1
	fi

	if [[ ! -r "${file_path}" ]]
	then
		echo "Error: Cannot read file: ${file_path}" >&2
		exit 1
	fi

	# Check write permission only if write-back is requested
	if [[ "${write_back}" == true ]] && [[ ! -w "${file_path}" ]]
	then
		echo "Error: Cannot write to file: ${file_path}" >&2
		exit 1
	fi

	content="$(cat "${file_path}")"
else
	content="$(cat)"
fi

# Check for canary (unless --force is used)
if [[ "${force}" == false ]] && [[ "${content}" == *"${CANARY}"* ]]
then
	echo "Error: Content already contains a summary (canary detected)" >&2
	echo "Use --force to append another summary anyway" >&2
	exit 1
fi

# Generate summary (handle empty forward_args array)
if [[ ${#forward_args[@]} -gt 0 ]]
then
	summary="$(echo "${content}" | ai_summary_as_markdown "${forward_args[@]}")"
else
	summary="$(echo "${content}" | ai_summary_as_markdown)"
fi

# Output or write back
if [[ "${write_back}" == true ]]
then
	# Append separator and summary to file
	printf '%s%s' "${separator}" "${summary}" >> "${file_path}"
	echo "Summary appended to ${file_path}" >&2
else
	# Output original content + separator + summary to stdout
	printf '%s%s%s' "${content}" "${separator}" "${summary}"
fi
