#!/bin/bash 
set -euo pipefail

notes_dir="${HOME}/Documents/notes"
bookmarks_file="${notes_dir}/02_areas/bookmarks.norg"
do_open=0
do_copy=0

if [[ ! -d "${notes_dir}" ]] 
then 
    echo "${notes_dir} does not exist. have you cloned it yet?"
    exit 1
fi

if [[ ! -f "${bookmarks_file}" ]]
then 
    echo "${bookmarks_file} does not exist."
    exit 1
fi


# basic arg parsing
if [[ $# -ge 1 ]]
then 
    if [[ "${1}" == "--help" ]] || [[ "${1}" == "-h" ]]
    then 
        echo -e "Usage:"
        echo -e "  -h,--help\tshow this message"
        echo -e "  -e,--edit\topen file in $EDITOR"
        echo -e "  -y,--yaml\tprint out yaml"
        echo -e "  -o,--open\tinvoke xdg-open with selected bookmark"
        echo -e "  -c,--copy\tcopy url to clipboard"
        exit 0
    elif [[ "${1}" == "--edit" ]] || [[ "${1}" == "-e" ]]
    then 
        exec bash -c "cd ${notes_dir} && ${EDITOR} ${bookmarks_file}"
    elif [[ "${1}" == "--yaml" ]] || [[ "${1}" == "-y" ]]
    then 
        exec norg_links_to_yaml "bookmarks" < "${bookmarks_file}"
    elif [[ "${1}" == "--open" ]] || [[ "${1}" == "-o" ]]
    then 
        do_open=1
    elif [[ "${1}" == "--copy" ]] || [[ "${1}" == "-c" ]]
    then 
        do_copy=1
    fi
fi


selected_url=$(norg_links_to_yaml "bookmarks" < "${bookmarks_file}" | \
    yq .bookmarks[].name | \
    fzf \
        -i \
        --height=100% \
        --preview="yq '.bookmarks[] | select(.name == \"{}\").url' < <(norg_links_to_yaml bookmarks < ${bookmarks_file})" \
        --tmux center | \
    tr -d '\n' | \
    xargs -0 -I % bash -c "yq '.bookmarks[] | select(.name == \"%\").url' < <(norg_links_to_yaml bookmarks < ${bookmarks_file})" | \
    xargs -0 -I % echo -e '%')


if [[ "${do_open}" == "1" ]]
then 
    exec xdg-open "${selected_url}"
elif [[ "${do_copy}" == "1" ]]
then 
    wl-copy <<< "${selected_url}"
else 
    echo "${selected_url}"
fi

