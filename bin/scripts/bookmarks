#!/bin/bash 
set -euo pipefail

notes_dir="${HOME}/Documents/notes"
bookmarks_file="${notes_dir}/02_areas/bookmarks.norg"
do_open=0
do_copy=0
do_group_list=0
do_group_list_yaml=0
group=""
yq_name_filter=""

if [[ ! -d "${notes_dir}" ]] 
then 
    echo "${notes_dir} does not exist. have you cloned it yet?"
    exit 1
fi

if [[ ! -f "${bookmarks_file}" ]]
then 
    echo "${bookmarks_file} does not exist."
    exit 1
fi


# basic arg parsing
while [[ ${#} -gt 0 ]]
do
    arg="${1}"
    if [[ "${arg}" == "--help" ]] || [[ "${arg}" == "-h" ]]
    then 
        echo -e "Usage:"
        echo -e "  -h,--help\tshow this message"
        echo -e "  -e,--edit\topen file in $EDITOR"
        echo -e "  -y,--yaml\tprint out yaml"
        echo -e "  -o,--open\tinvoke xdg-open with selected bookmark"
        echo -e "  -c,--copy\tcopy url to clipboard"
        echo -e "  -g,--group\tonly show bookmarks for a specific group"
        echo -e "  -l,--list\tlist all groups (in plain text)"
        echo -e "  -L,--listy\tlist all groups (in yaml)"
        exit 0
    elif [[ "${arg}" == "--edit" ]] || [[ "${arg}" == "-e" ]]
    then 
        exec bash -c "cd ${notes_dir} && ${EDITOR} ${bookmarks_file}"
    elif [[ "${arg}" == "--yaml" ]] || [[ "${arg}" == "-y" ]]
    then 
        exec norg_links_to_yaml "bookmarks" < "${bookmarks_file}"
    elif [[ "${arg}" == "--open" ]] || [[ "${arg}" == "-o" ]]
    then 
        do_open=1
    elif [[ "${arg}" == "--copy" ]] || [[ "${arg}" == "-c" ]]
    then 
        do_copy=1
    elif [[ "${arg}" == "--group" ]] || [[ "${arg}" == "-g" ]]
    then
        shift
        group="${1}"
    elif [[ "${arg}" == "--list" ]] || [[ "${arg}" == "-l" ]]
    then 
        do_group_list=1
    elif [[ "${arg}" == "--listy" ]] || [[ "${arg}" == "-L" ]]
    then 
        do_group_list_yaml=1
    fi
    shift
done


# group listing mode
if [[ "${do_group_list}" == "1" ]] || [[ "${do_group_list_yaml}" == "1" ]]
then
    if [[ "${do_group_list_yaml}" == "1" ]]
    then
        echo "---"
        echo "bookmark_groups:"
    fi
    while read -r line 
    do
        if [[ "${do_group_list_yaml}" == "1" ]]
        then
            echo "  - ${line}"
        else 
            echo "${line}"
        fi
    done < <(norg_links_to_yaml "bookmarks" < "${bookmarks_file}" | yq .bookmarks[].group | sort -u)
    exit 0
fi



# group filtering
if [[ "${group}" == "" ]]
then
    yq_name_filter='.bookmarks[].name'

else
    yq_name_filter=".bookmarks[] | select(.group == \"${group}\").name"
fi


# do the actual work
selected_url=$(norg_links_to_yaml "bookmarks" < "${bookmarks_file}" | \
    yq "${yq_name_filter}" | \
    sort | \
    fzf \
        -i \
        --height=100% \
        --preview="yq '.bookmarks[] | select(.name == \"{}\") | (.group, .url)' < <(norg_links_to_yaml bookmarks < ${bookmarks_file})" \
        --tmux center | \
    tr -d '\n' | \
    xargs -0 -I % bash -c "yq '.bookmarks[] | select(.name == \"%\").url' < <(norg_links_to_yaml bookmarks < ${bookmarks_file})" | \
    xargs -0 -I % echo -e '%')


# post url-selection logic
if [[ "${do_open}" == "1" ]]
then 
    exec xdg-open "${selected_url}"
elif [[ "${do_copy}" == "1" ]]
then 
    wl-copy <<< "${selected_url}"
else 
    echo "${selected_url}"
fi

