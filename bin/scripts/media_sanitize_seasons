#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Script name and version
SCRIPT_NAME=$(basename "$0")
VERSION="1.0.0"

# Default options
DRY_RUN=false

# Function to display usage
usage() {
    cat << EOF
Usage: $SCRIPT_NAME [OPTIONS] [DIRECTORY]

Rename Season folders to standardized format (season_01, season_02, etc.)

This script searches for folders with season indicators and renames them to 'season_NN' format.

Supported patterns:
  - 'Season 1' or 'season 1' (with space)
  - 'Season1' or 'season1' (without space)  
  - 'S03' or 's03' (abbreviated format)
  
All patterns are renamed to 'season_NN' with zero-padded numbers.

OPTIONS:
    -h, --help      Show this help message
    -v, --version   Show version information
    -d, --dry-run   Show what would be renamed without making changes

ARGUMENTS:
    DIRECTORY       Directory to search in (default: current directory)

EXAMPLES:
    # Rename Season folders in current directory
    $SCRIPT_NAME

    # Rename Season folders in specific directory
    $SCRIPT_NAME /media/tvshows

    # Preview changes without renaming
    $SCRIPT_NAME --dry-run /media/tvshows

BEHAVIOR:
    - Renames folders matching: '[Ss]eason \\d{1,2}', '[Ss]eason\\d{1,2}', or '[Ss]\\d{1,2}'
    - Converts all to lowercase 'season_' prefix format
    - Zero-pads numbers to 2 digits (s1 -> season_01, Season12 -> season_12)
    - Searches in subdirectories of the specified directory
    - Does not recurse deeper than immediate subdirectories

EOF
}

# Function to show version
version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -v|--version)
            version
            exit 0
            ;;
        -d|--dry-run)
            DRY_RUN=true
            shift
            ;;
        -*)
            echo "Error: Unknown option: $1" >&2
            usage
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# Get target directory (default to current directory)
TARGET_DIR="${1:-.}"

# Check if target directory exists
if [[ ! -d "$TARGET_DIR" ]]; then
    echo "Error: Directory '$TARGET_DIR' does not exist" >&2
    exit 1
fi

# Convert to absolute path
TARGET_DIR=$(realpath "$TARGET_DIR")

echo "Searching for Season folders in: $TARGET_DIR"
if [[ "$DRY_RUN" == true ]]; then
    echo "DRY RUN MODE - No changes will be made"
fi
echo

# Counter for found folders
found_count=0
renamed_count=0

# Find all subdirectories in the target directory
for parent_dir in "$TARGET_DIR"/*; do
    # Skip if not a directory
    [[ ! -d "$parent_dir" ]] && continue
    
    # Look for Season folders within this directory
    for season_dir in "$parent_dir"/*; do
        # Skip if not a directory
        [[ ! -d "$season_dir" ]] && continue
        
        # Get just the directory name
        dir_name=$(basename "$season_dir")
        
        # Check if it matches any of the Season patterns
        season_num=""
        
        # Pattern 1: "Season 1" or "season 12" (with space)
        if [[ "$dir_name" =~ ^[Ss]eason[[:space:]]+([0-9]{1,2})$ ]]; then
            season_num="${BASH_REMATCH[1]}"
        # Pattern 2: "Season1" or "season12" (without space)
        elif [[ "$dir_name" =~ ^[Ss]eason([0-9]{1,2})$ ]]; then
            season_num="${BASH_REMATCH[1]}"
        # Pattern 3: "s03" or "S03" (abbreviated)
        elif [[ "$dir_name" =~ ^[Ss]([0-9]{1,2})$ ]]; then
            season_num="${BASH_REMATCH[1]}"
        fi
        
        # If we found a match, process it
        if [[ -n "$season_num" ]]; then
            found_count=$((found_count + 1))
            
            # Zero-pad the number to 2 digits
            # Use arithmetic to avoid octal interpretation
            padded_num=$(printf "%02d" $((10#$season_num)))
            
            # Create new name
            new_name="season_${padded_num}"
            
            # Get parent directory path
            parent_path=$(dirname "$season_dir")
            
            # Full paths for old and new
            old_path="$season_dir"
            new_path="$parent_path/$new_name"
            
            # Check if target already exists
            if [[ -e "$new_path" ]]; then
                echo "Warning: Cannot rename '$old_path' to '$new_path' - target already exists"
                continue
            fi
            
            # Show what would be done
            echo "Rename: $(basename "$parent_path")/$dir_name -> $(basename "$parent_path")/$new_name"
            
            # Perform rename if not dry run
            if [[ "$DRY_RUN" == false ]]; then
                if mv "$old_path" "$new_path"; then
                    renamed_count=$((renamed_count + 1))
                else
                    echo "Error: Failed to rename '$old_path' to '$new_path'" >&2
                fi
            else
                echo "  Command: mv \"$old_path\" \"$new_path\""
                renamed_count=$((renamed_count + 1))
            fi
        fi
    done
done

# Summary
echo
if [[ "$found_count" -eq 0 ]]; then
    echo "No Season folders found to rename"
else
    if [[ "$DRY_RUN" == true ]]; then
        echo "Found $found_count Season folder(s) that would be renamed"
    else
        echo "Renamed $renamed_count of $found_count Season folder(s)"
    fi
fi