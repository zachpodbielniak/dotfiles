#!/usr/bin/python3

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Container check for distrobox - do this BEFORE any other imports
import os
import subprocess
import sys

ctr_id = os.environ.get("CONTAINER_ID", "")
no_dbox_check = os.environ.get("NO_DBOX_CHECK", "").lower() in ("1", "true")
if not no_dbox_check and ctr_id != "dev":
	cmd = ["distrobox", "enter", "dev", "--", *sys.argv]
	subprocess.run(cmd)
	sys.exit(0)

# Now import everything else inside the dev container
import argparse
import json
from pathlib import Path
from anthropic import Anthropic


def count_tokens_in_content(content: str) -> int:
	"""Count tokens in given content using Anthropic API."""
	client = Anthropic()
	response = client.messages.count_tokens(
		model="claude-opus-4-20250514",
		messages=[
			{"role": "user", "content": content}
		],
	)
	return response.input_tokens


def read_file(file_path: str) -> str:
	"""Read file content."""
	try:
		with open(file_path, 'r', encoding='utf-8') as f:
			return f.read()
	except FileNotFoundError:
		print(f"token_count: file not found: {file_path}", file=sys.stderr)
		sys.exit(1)
	except Exception as e:
		print(f"token_count: error reading {file_path}: {e}", file=sys.stderr)
		sys.exit(1)


def main():
	parser = argparse.ArgumentParser(
		prog='token_count',
		description='Count tokens in files using Claude\'s tokenizer',
		formatter_class=argparse.RawDescriptionHelpFormatter,
		epilog="""Examples:
  token_count file1.txt file2.txt
  token_count -y file1.txt
  token_count -o file1.txt file2.txt file3.txt
  cat file.txt | token_count
  token_count --only-sum --simple file1.txt file2.txt file3.txt"""
	)

	parser.add_argument(
		'files',
		nargs='*',
		help='Files to count tokens for (omit to read from stdin)'
	)
	parser.add_argument(
		'-y', '--yaml',
		action='store_true',
		help='Output in YAML format'
	)
	parser.add_argument(
		'-n', '--no-sum',
		action='store_true',
		help='Don\'t show the total sum'
	)
	parser.add_argument(
		'-o', '--only-sum',
		action='store_true',
		help='Show only the total, not per-file counts'
	)
	parser.add_argument(
		'--simple',
		action='store_true',
		help='Don\'t show filenames (useful with --only-sum or single file)'
	)
	parser.add_argument(
		'--license',
		action='store_true',
		help='Show license information'
	)

	args = parser.parse_args()

	if args.license:
		print("""Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.""")
		sys.exit(0)

	# Determine input files
	files_to_process: list[str] = args.files
	stdin_content = ""

	if not files_to_process and not sys.stdin.isatty():
		stdin_content = sys.stdin.read()
		files_to_process = ["-"]

	if not files_to_process:
		parser.print_help()
		sys.exit(1)

	# Count tokens for each file
	token_counts: dict[str, int] = {}
	total_tokens: int = 0

	for file_path in files_to_process:
		if file_path == "-":
			content = stdin_content
			display_name = "<stdin>"
		else:
			content = read_file(file_path)
			display_name = file_path

		try:
			token_count = count_tokens_in_content(content)
		except Exception as e:
			print(f"token_count: error counting tokens for {display_name}: {e}", file=sys.stderr)
			sys.exit(1)

		token_counts[display_name] = token_count
		total_tokens += token_count

	# Output results
	if args.yaml:
		if not args.only_sum:
			print("files:")
			for file_path in files_to_process:
				if file_path == "-":
					display_name = "<stdin>"
				else:
					display_name = file_path
				print(f"  '{display_name}': {token_counts[display_name]}")
		if not args.no_sum:
			print(f"total: {total_tokens}")
	else:
		# Standard text output
		if not args.only_sum:
			for file_path in files_to_process:
				if file_path == "-":
					display_name = "<stdin>"
				else:
					display_name = file_path
				if args.simple:
					print(f"{token_counts[display_name]}")
				else:
					print(f"{display_name}: {token_counts[display_name]}")
		if not args.no_sum:
			if args.simple:
				print(f"{total_tokens}")
			else:
				print(f"total: {total_tokens}")


if __name__ == "__main__":
	main()
