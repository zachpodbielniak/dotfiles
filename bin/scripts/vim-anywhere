#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

notes_dir="${HOME}/Documents/notes"
vim_anywhere_log="${notes_dir}/03_resources/vim-anywhere/$(today).md"
mode="fresh"

# Detect display server type for clipboard operations
if [[ -n "${WAYLAND_DISPLAY:-}" ]] || [[ "${XDG_SESSION_TYPE:-}" == "wayland" ]]; then
    CLIPBOARD_COPY="wl-copy"
    CLIPBOARD_PASTE="wl-paste"
else
    CLIPBOARD_COPY="xclip -selection clipboard"
    CLIPBOARD_PASTE="xclip -selection clipboard -o"
fi

print_help() {
    echo -e "Usage: $(basename "${0}") <args>"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -p,--paste\tread from clipboard first"
}

if [[ ! -d "$(dirname "${vim_anywhere_log}")" ]]
then 
    mkdir -p "$(dirname "${vim_anywhere_log}")"
fi

if [[ ! -f "${vim_anywhere_log}" ]]
then 
    touch "${vim_anywhere_log}"
fi


while [[ $# -gt 0 ]]
do 
    case "${1}" in 
        -h|--help)
            print_help
            exit 0
            ;;
        -p|--paste)
            mode="paste"
            ;;
    esac
    shift
done


case "${mode}" in 
    "fresh")
        vipe_data=$(vipe)
        ;;
    "paste")
        vipe_data=$(vipe < <(${CLIPBOARD_PASTE}))
        ;;
esac

if [[ "${vipe_data}" == "" ]]
then 
    exit 0
fi

# Format output as markdown with timestamp as heading and content in code block
timestamp="$(date +'%Y-%m-%d %H:%M:%S')"
printf "## %s\n\n\`\`\`\n%s\n\`\`\`\n\n" \
    "${timestamp}" \
    "${vipe_data}" >> "${vim_anywhere_log}"

# Copy to clipboard using appropriate tool
echo "${vipe_data}" | ${CLIPBOARD_COPY}

