#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

TREES_DIR="./trees"

show_help () {
    cat << 'EOF'
worktree - Git worktree wrapper that standardizes worktree placement

USAGE:
    worktree <subcommand> [options]

SUBCOMMANDS:
    add <branch> [parent]       Create a new worktree with a new branch
                                Parent defaults to 'master'
    rm <branch> [--delete-branch]
                                Remove a worktree, optionally delete the branch
    ls                          List all worktrees

OPTIONS:
    -h, --help                  Show this help message
    --license                   Show license information

EXAMPLES:
    worktree add feature/new-feature          # Create worktree from master
    worktree add bugfix/fix-123 develop       # Create worktree from develop
    worktree rm feature/new-feature           # Remove worktree only
    worktree rm bugfix/fix-123 --delete-branch # Remove worktree and branch
    worktree ls                               # List all worktrees

NOTES:
    All worktrees are created under ./trees/ directory.
    The script ensures 'trees/' is added to .gitignore if not present.
EOF
}

show_license () {
    cat << 'EOF'
worktree - Git worktree wrapper
Copyright (C) 2025  Zach Podbielniak

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
EOF
}

ensure_git_repo () {
    # Verify we are inside a git repository
    if ! git rev-parse --is-inside-work-tree &>/dev/null
    then
        echo "Error: Not inside a git repository" >&2
        exit 1
    fi
}

ensure_trees_dir () {
    # Create the trees directory if it does not exist
    if [[ ! -d "${TREES_DIR}" ]]
    then
        mkdir -p "${TREES_DIR}"
    fi
}

ensure_gitignore () {
    # Ensure 'trees/' is in .gitignore
    local gitignore=".gitignore"
    local entry="trees/"

    if [[ ! -f "${gitignore}" ]]
    then
        echo "${entry}" > "${gitignore}"
        echo "Created .gitignore with 'trees/' entry"
        return
    fi

    # Check if trees/ already in gitignore (handles 'trees/', './trees/', '/trees/')
    if ! grep -qE "^\.?/?trees/?$" "${gitignore}"
    then
        echo "${entry}" >> "${gitignore}"
        echo "Added 'trees/' to .gitignore"
    fi
}

cmd_add () {
    # Create a new worktree with a new branch
    if [[ $# -lt 1 ]]
    then
        echo "Error: 'add' requires a branch name" >&2
        echo "Usage: worktree add <branch> [parent]" >&2
        exit 1
    fi

    local branch="${1}"
    local parent="${2:-master}"
    local worktree_path="${TREES_DIR}/${branch}"

    ensure_git_repo
    ensure_trees_dir
    ensure_gitignore

    # Check if branch already exists
    if git show-ref --verify --quiet "refs/heads/${branch}"
    then
        echo "Error: Branch '${branch}' already exists" >&2
        exit 1
    fi

    # Check if parent branch/ref exists
    if ! git rev-parse --verify "${parent}" &>/dev/null
    then
        echo "Error: Parent '${parent}' does not exist" >&2
        exit 1
    fi

    # Create the worktree with a new branch
    git worktree add -b "${branch}" "${worktree_path}" "${parent}"
    echo "Created worktree at '${worktree_path}' with branch '${branch}' from '${parent}'"
}

cmd_rm () {
    # Remove a worktree, optionally delete the branch
    if [[ $# -lt 1 ]]
    then
        echo "Error: 'rm' requires a branch name" >&2
        echo "Usage: worktree rm <branch> [--delete-branch]" >&2
        exit 1
    fi

    local branch="${1}"
    local delete_branch="false"
    local worktree_path="${TREES_DIR}/${branch}"

    # Parse optional --delete-branch flag
    if [[ $# -ge 2 ]] && [[ "${2}" == "--delete-branch" ]]
    then
        delete_branch="true"
    fi

    ensure_git_repo

    # Check if worktree exists
    if [[ ! -d "${worktree_path}" ]]
    then
        echo "Error: Worktree '${worktree_path}' does not exist" >&2
        exit 1
    fi

    # Remove the worktree
    git worktree remove "${worktree_path}"
    echo "Removed worktree at '${worktree_path}'"

    # Optionally delete the branch
    if [[ "${delete_branch}" == "true" ]]
    then
        if git show-ref --verify --quiet "refs/heads/${branch}"
        then
            git branch -D "${branch}"
            echo "Deleted branch '${branch}'"
        else
            echo "Warning: Branch '${branch}' does not exist, skipping deletion" >&2
        fi
    fi
}

cmd_ls () {
    # List all worktrees
    ensure_git_repo
    git worktree list
}

main () {
    # Handle global options first
    if [[ $# -eq 0 ]]
    then
        show_help
        exit 0
    fi

    case "${1}" in
        -h|--help)
            show_help
            exit 0
            ;;
        --license)
            show_license
            exit 0
            ;;
        add)
            shift
            cmd_add "$@"
            ;;
        rm)
            shift
            cmd_rm "$@"
            ;;
        ls)
            cmd_ls
            ;;
        *)
            echo "Error: Unknown subcommand '${1}'" >&2
            echo "Run 'worktree --help' for usage information" >&2
            exit 1
            ;;
    esac
}

main "$@"
