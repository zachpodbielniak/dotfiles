#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

SCREENCASTS_DIR="${HOME}/Videos/Screencasts"
OUTPUT_FILE="${SCREENCASTS_DIR}/last_screencast.mp4"

# Default resolution (720p)
RESOLUTION="1280x720"

# Default CRF (quality)
CRF="28"

show_help() {
    cat << 'EOF'
convert_last_screencast - Convert the most recent screencast to MP4

USAGE:
    convert_last_screencast [OPTIONS]

DESCRIPTION:
    Finds the most recent screencast recording in ~/Videos/Screencasts
    matching the pattern 'Screencast From YYYY-MM-DD HH-MM-SS.webm' and
    converts it to a highly compatible MP4 format for easy sharing.

    Output is saved to ~/Videos/Screencasts/last_screencast.mp4

OPTIONS:
    -h, --help       Show this help message

    Resolution Options (default: --medium / 720p):
    --very-low       240p  (426x240)   - Smallest file size
    --low            480p  (854x480)   - Small file size
    --medium         720p  (1280x720)  - Default, good balance
    --high           1080p (1920x1080) - High quality
    --very-high      1440p (2560x1440) - Very high quality
    --ultra-high     2160p (3840x2160) - 4K, largest file size

    Quality Options:
    --crf VALUE      CRF value 0-51 (default: 28)
                     Lower = better quality, larger file
                     Higher = lower quality, smaller file

COMPRESSION SETTINGS:
    - Video codec: H.264 (maximum compatibility)
    - Hardware acceleration: Disabled (consistent output)

EXAMPLES:
    # Convert with default 720p resolution
    convert_last_screencast

    # Convert with lower resolution for smaller file
    convert_last_screencast --low

    # Convert with high quality 1080p
    convert_last_screencast --high

    # Convert with custom CRF for better quality
    convert_last_screencast --crf 23

    # Combine resolution and CRF
    convert_last_screencast --high --crf 20

LICENSE:
    AGPLv3 - https://www.gnu.org/licenses/agpl-3.0.html
EOF
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        --very-low)
            RESOLUTION="426x240"
            shift
            ;;
        --low)
            RESOLUTION="854x480"
            shift
            ;;
        --medium)
            RESOLUTION="1280x720"
            shift
            ;;
        --high)
            RESOLUTION="1920x1080"
            shift
            ;;
        --very-high)
            RESOLUTION="2560x1440"
            shift
            ;;
        --ultra-high)
            RESOLUTION="3840x2160"
            shift
            ;;
        --crf)
            if [[ -z "${2:-}" ]]; then
                echo "Error: --crf requires a value"
                exit 1
            fi
            if ! [[ "$2" =~ ^[0-9]+$ ]] || [[ "$2" -lt 0 ]] || [[ "$2" -gt 51 ]]; then
                echo "Error: CRF must be a number between 0 and 51"
                exit 1
            fi
            CRF="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use -h or --help for usage information"
            exit 1
            ;;
    esac
done

# Validate screencasts directory exists
if [[ ! -d "${SCREENCASTS_DIR}" ]]; then
    echo "Error: Screencasts directory does not exist: ${SCREENCASTS_DIR}"
    exit 1
fi

# Change to screencasts directory so compress_video.log is written there
cd "${SCREENCASTS_DIR}"

# Find the most recent screencast file
# Using ls -t to sort by modification time (newest first)
latest_screencast=$(ls -t Screencast\ From\ *.webm 2>/dev/null | head -n 1)

if [[ -z "${latest_screencast}" ]]; then
    echo "Error: No screencast files found matching 'Screencast From *.webm'"
    exit 1
fi

echo "Converting: ${latest_screencast}"
echo "Resolution: ${RESOLUTION}"
echo "CRF: ${CRF}"
echo "Output: ${OUTPUT_FILE}"

# Run compress_video with sharing-optimized settings
# Note: Resolution ensures dimensions are divisible by 2 (H.264 requirement)
compress_video \
    -y \
    --crf "${CRF}" \
    --no-hwaccel \
    --video-codec h264 \
    --resolution "${RESOLUTION}" \
    --output-file "${OUTPUT_FILE}" \
    "${latest_screencast}"

echo "Done! Output saved to: ${OUTPUT_FILE}"
