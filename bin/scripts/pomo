#!/usr/bin/env perl
use strict;
use warnings;
use YAML::XS 'LoadFile', 'DumpFile';
use Time::Piece;
binmode(STDOUT, ":encoding(UTF-8)");


my $home_dir = $ENV{HOME};
my $yaml_config = "$home_dir/.config/pomodoro.yaml";
my $yaml_state = "$home_dir/.local/state/pomodoro_state.yaml";

`touch $yaml_state`;

# load the yaml files
my $config = LoadFile($yaml_config);
my $state = LoadFile($yaml_state);

# read yaml config
my $session_time = $config->{defaults}->{session_time};
my $break_time = $config->{defaults}->{break_time};
my $icon_pomo = $config->{defaults}->{icon_pomo};
my $icon_break = $config->{defaults}->{icon_break};

my $operation = "status";


while (my $arg = shift @ARGV) {
    if ("-h" eq $arg || "--help" eq $arg) {
        print("pomo usage:\n");
        print("-----------\n");
        print("  -h,--help\tshow this menu\n");
        print("  -s,--start\tstart pomo using defaults if -t/-b are not set\n");
        print("  -S,--stop\tstop pomo timer\n");
        print("  -t,--time\tuse a time other than the default time (~/.config/pomodoro.yaml)\n");
        print("  -b,--break\tuse a break time other than the default time (~/.config/pomodoro.yaml)\n");
        exit(0)
    }

    if ("-s" eq $arg || "--start" eq $arg) {
        $operation = "start";
    }

    if ("-S" eq $arg || "--stop" eq $arg) {
        $operation = "stop";
    }

    if ("-t" eq $arg || "--time" eq $arg) {
        $session_time = shift @ARGV;
    }

    if ("-b" eq $arg || "--break" eq $arg) {
        $break_time = shift @ARGV;
    }
}

# Where the magic happens
if ("start" eq $operation) {
    my $cur_time = localtime;
    my $end_time = $cur_time + ($session_time * 60);
    my $break_end = $end_time + ($break_time * 60);
    $state->{start_time} = $cur_time->epoch;
    $state->{end_time} = int($end_time->epoch);
    $state->{break_end} = $break_end->epoch;
    $state->{status} = "work";
    DumpFile($yaml_state, $state);
} elsif ("stop" eq $operation) {
    $state->{status} = "stopped";
} elsif ("status" eq $operation) {
    if (exists $state->{status}) {
        my $status = $state->{status};

        # Check to see if we are past time
        if ("work" eq $status) {
            my $cur_time = localtime;
            my $end_time = localtime($state->{end_time});
            if ($cur_time->epoch > $end_time->epoch) {
                $status = "break";
                $state->{status} = $status;
                DumpFile($yaml_state, $state);
            }
        }
        
        if ("work" eq $status) {
            my $cur_time = localtime;
            my $end_time = localtime($state->{end_time});
            my $time_left = $end_time - $cur_time;
            my $time_left_min = int($time_left/60);
            my $time_left_sec = $time_left%60;
            printf("$icon_pomo %.2d:%.2d\n", $time_left_min, $time_left_sec);
        } elsif ("break" eq $status) {  
            my $cur_time = localtime;
            my $end_time = localtime($state->{break_end});
            my $time_left = $end_time - $cur_time;
            my $time_left_min = int($time_left/60);
            my $time_left_sec = $time_left%60;

            if ($time_left_min < 0) { 
                $time_left_min = 0;
                $time_left_sec = 0;
            }
            
            # Use modulus to do a "flashing" like effect
            if ($time_left_sec%2 == 1) {
                printf("$icon_break %.2d:%.2d\n", $time_left_min, $time_left_sec);
            } else {
                printf("$icon_pomo %.2d:%.2d\n", $time_left_min, $time_left_sec);
            }
        } elsif ("stopped" eq $status) {
            print("");
        }
    } else {
        print("pomo is not setup");
    }
} else {
    die("$operation is not a valid operation\n");
}

