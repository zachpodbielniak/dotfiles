#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
histogram - Generate frequency distribution

USAGE:
	histogram [OPTIONS]

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--top N         Show only top N most frequent
	--bar           Show ASCII bar chart
	--percent       Show percentages instead of counts
	--sort type     Sort by count (default) or value

EXAMPLES:
	echo -e "a\na\na\nb\nb\nc" | histogram
	echo -e "a\na\na\nb\nb\nc" | histogram --top 2
	echo -e "a\na\na\nb" | histogram --bar

DESCRIPTION:
	Count frequency of each unique line and display in
	tabular or graphical format.

EOF
}

top=0
show_bar=false
show_percent=false
sort_type="count"

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		--top)
			top="$2"
			shift 2
			;;
		--bar)
			show_bar=true
			shift
			;;
		--percent)
			show_percent=true
			shift
			;;
		--sort)
			sort_type="$2"
			shift 2
			;;
		*)
			echo "histogram: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Count frequencies and generate histogram
awk -v top="$top" -v show_bar="$show_bar" -v show_percent="$show_percent" -v sort_type="$sort_type" '
	{
		count[$0]++
		total++
	}
	END {
		n = 0
		for (line in count) {
			lines[++n] = line
			counts[line] = count[line]
		}

		# Sort by count or value
		if (sort_type == "count") {
			for (i = 1; i <= n; i++) {
				for (j = i+1; j <= n; j++) {
					if (counts[lines[i]] < counts[lines[j]]) {
						tmp = lines[i]
						lines[i] = lines[j]
						lines[j] = tmp
					}
				}
			}
		}

		# Limit to top N if specified
		limit = (top > 0 && top < n) ? top : n

		for (i = 1; i <= limit; i++) {
			line = lines[i]
			cnt = counts[line]
			if (show_percent) {
				pct = (cnt * 100.0) / total
				printf "%s\t%.1f%%\n", line, pct
			} else if (show_bar) {
				bars = int(cnt / 2)
				printf "%s\t%s (%d)\n", line, substr("################################", 1, bars), cnt
			} else {
				printf "%s\t%d\n", line, cnt
			}
		}
	}
'
