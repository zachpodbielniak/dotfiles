#!/bin/bash 
set -euo pipefail

provider_args=()
files=()
content=""
content_set="false"
provider="grokpy"
gather="false"
sanitize="false"


print_help() { 
    echo -e "Usage: $(basename "${0}") -p <prompt> [-P <provider>] [-f <file_1> -f <file_2>...] [provider_args]"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -P,--provider\tprovider to use (claudpy, grokpy, geminpy, perpy, ollampy, openpy (default: grokpy))"
    echo -e "  -f,--file\tfile to read in as context (also reads in from stdin)"
    echo -e "  -p,--prompt\tprompt to forward to the provider with the context"
    echo -e "  -g,--gather\tdo not forward to provider, rather, just gather context and dump to stdout"
    echo -e "  -s,--sanitize\tsanitize data before forwarding to the provider"
}


while [[ ${#} -gt 0 ]]
do 
    case "${1}" in
        -h|--help)
            print_help
            exit 0
            ;;
        -P|--provider)
            provider="${2}"
            shift
            ;;
        -f|--file)
            files+=("${2}")
            shift
            ;;
        -p|--prompt)
            content="${2}"
            content_set="true"
            shift
            ;;
        -g|--gather)
            gather="true"
            ;;
        -s|--sanitize)
            sanitize="true"
            ;;
        *)
            provider_args+=("${2}")
            shift
            ;;
    esac
    shift
done


if [[ "false" != "${gather}" ]]
then 
    printf -v content "%s\n\n# TASK\n- answer the above query with the context below\n\n-------------------------------------------\n\n" "${content}"
fi

for f in ${files[@]}
do 
    content="${content}$(cat "${f}")\n"
done

if [[ "true" == "${sanitize}" ]]
then 
    content="$(sanitize_data <<< "${content}")"
fi

if [[ "true" == "${gather}" ]]
then 
    cat <<< "${content}"
    exit 0
fi 

"${provider}" ${provider_args[@]} <<< "${content}"

