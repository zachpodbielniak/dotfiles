#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

provider_args=()
files=()
content="" 
provider="grokpy"
gather="false"
sanitize="false"

printf -v content "%s\n" "# PROMPT:"

print_help() { 
    echo -e "Usage: $(basename "${0}") -p <prompt> [-P <provider>] [-f <file_1> -f <file_2>...] [provider_args]"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -P,--provider\tprovider to use (claudpy, grokpy, geminpy, perpy, ollampy, openpy (default: grokpy))"
    echo -e "  -f,--file\tfile to read in as context (also reads in from stdin)"
    echo -e "  -p,--prompt\tprompt to forward to the provider with the context"
    echo -e "  -g,--gather\tdo not forward to provider, rather, just gather context and dump to stdout"
    echo -e "  -s,--sanitize\tsanitize data before forwarding to the provider"
}


while [[ ${#} -gt 0 ]]
do 
    case "${1}" in
        -h|--help)
            print_help
            exit 0
            ;;
        -P|--provider)
            provider="${2}"
            shift
            ;;
        -f|--file)
            files+=("${2}")
            shift
            ;;
        -p|--prompt)
            content="${2}"
            shift
            ;;
        -g|--gather)
            gather="true"
            ;;
        -s|--sanitize)
            sanitize="true"
            ;;
        *)
            provider_args+=("${2}")
            shift
            ;;
    esac
    shift
done

while IFS= read -r line 
do 
    printf -v content "%s%s\n" "${content}" "${line}"
done 

if [[ "false" != "${gather}" ]]
then 
    printf -v content "%s\n\n# TASK\n- answer the above query with the context below\n\n-------------------------------------------\n\n" "${content}"
fi

for f in ${files[@]}
do 
    content="${content}$(cat "${f}")\n"
done

if [[ "true" == "${sanitize}" ]]
then 
    content="$(sanitize_data <<< "${content}")"
fi

if [[ "true" == "${gather}" ]]
then 
    cat <<< "${content}"
    exit 0
fi 

"${provider}" ${provider_args[@]} <<< "${content}"

