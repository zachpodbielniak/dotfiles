#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
mimetype - Detect MIME type of file

USAGE:
	mimetype [OPTIONS] <file>

OPTIONS:
	-h, --help          Show this help message
	--license           Show license information
	--extension         Output typical extension
	--stdin             Read from stdin

EXAMPLES:
	mimetype document.pdf
	mimetype /var/log/app.log --extension
	cat binary_data | mimetype --stdin

EOF
}

extension_only=false
from_stdin=false
file=""

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--extension) extension_only=true; shift ;;
		--stdin) from_stdin=true; shift ;;
		*)
			if [[ -z "$file" ]]; then
				file="${1}"
				shift
			else
				echo "Error: unexpected argument '$1'" >&2
				exit 1
			fi
			;;
	esac
done

if [[ "$from_stdin" == true ]]; then
	# Read from stdin to temp file
	file=$(mktemp)
	trap "rm -f '$file'" EXIT
	cat > "$file"
elif [[ -z "$file" ]]; then
	echo "Error: file argument required" >&2
	exit 1
fi

if [[ ! -e "$file" ]] && [[ "$from_stdin" != true ]]; then
	echo "Error: file not found: $file" >&2
	exit 1
fi

# Use file command to detect MIME type
mimetype=$(file --mime-type -b "$file" 2>/dev/null || echo "application/octet-stream")

if [[ "$extension_only" == true ]]; then
	# Convert MIME type to extension
	case "$mimetype" in
		text/plain) echo ".txt" ;;
		text/html) echo ".html" ;;
		text/css) echo ".css" ;;
		text/javascript) echo ".js" ;;
		application/json) echo ".json" ;;
		application/xml) echo ".xml" ;;
		application/pdf) echo ".pdf" ;;
		image/jpeg) echo ".jpg" ;;
		image/png) echo ".png" ;;
		image/gif) echo ".gif" ;;
		image/webp) echo ".webp" ;;
		audio/mpeg) echo ".mp3" ;;
		audio/wav) echo ".wav" ;;
		video/mp4) echo ".mp4" ;;
		video/webm) echo ".webm" ;;
		application/zip) echo ".zip" ;;
		application/gzip) echo ".gz" ;;
		application/x-tar) echo ".tar" ;;
		*) echo ".bin" ;;
	esac
else
	echo "$mimetype"
fi
