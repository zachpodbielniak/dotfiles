#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
human_duration - Convert seconds to human-readable duration

USAGE:
	human_duration [OPTIONS]

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	--short         Compact format (HH:MM:SS)
	--long          Verbose (1 hour, 1 minute, 1 second)

EXAMPLES:
	echo "3661" | human_duration
	echo "90061" | human_duration
	echo "3661" | human_duration --short

EOF
}

format="default"

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--short) format="short"; shift ;;
		--long) format="long"; shift ;;
		*) echo "Error: unexpected argument '$1'" >&2; exit 1 ;;
	esac
done

while IFS= read -r seconds; do
	if [[ -z "$seconds" ]] || ! [[ "$seconds" =~ ^[0-9]+$ ]]; then
		continue
	fi

	days=$((seconds / 86400))
	hours=$(((seconds % 86400) / 3600))
	minutes=$(((seconds % 3600) / 60))
	secs=$((seconds % 60))

	if [[ "$format" == "short" ]]; then
		# HH:MM:SS format
		printf "%02d:%02d:%02d\n" "$hours" "$minutes" "$secs"
	elif [[ "$format" == "long" ]]; then
		# Verbose format
		parts=()
		[[ $days -gt 0 ]] && parts+=("$days day$(( days != 1 ? s : ''))")
		[[ $hours -gt 0 ]] && parts+=("$hours hour$(( hours != 1 ? s : ''))")
		[[ $minutes -gt 0 ]] && parts+=("$minutes minute$(( minutes != 1 ? s : ''))")
		[[ $secs -gt 0 ]] && parts+=("$secs second$(( secs != 1 ? s : ''))")

		if [[ ${#parts[@]} -eq 0 ]]; then
			echo "0 seconds"
		else
			IFS=", " echo "${parts[*]}"
		fi
	else
		# Default format: "1d 1h 1m 1s"
		parts=()
		[[ $days -gt 0 ]] && parts+=("${days}d")
		[[ $hours -gt 0 ]] && parts+=("${hours}h")
		[[ $minutes -gt 0 ]] && parts+=("${minutes}m")
		[[ $secs -gt 0 ]] && parts+=("${secs}s")

		if [[ ${#parts[@]} -eq 0 ]]; then
			echo "0s"
		else
			echo "${parts[*]}"
		fi
	fi
done
