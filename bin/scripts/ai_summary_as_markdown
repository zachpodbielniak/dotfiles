#!/usr/bin/python3

import sys
import argparse
from sys import stdin, argv
from subprocess import run

# prompt_meeting: str = "below is a a transcript. summarize this into markdown format where various topics are split into different sections using bullet points. be sure to note any take aways (and who owns them if possible), any agreements that were had (if any), any lessons learned that were had (if any), and anything that can be improved (if any):\n"

prompt_meeting: str = """
Summarize the following meeting transcript by outlining:
- The meeting agenda
- Major discussion points, organized under relevant agenda sections and listed as bullet points
- What decisions were agreed upon
- Key takeaways from the meeting, specifying who owns each action item.
Give the output in strictly markdown format.
"""

prompt_book: str = """
Provide a comprehensive summary of the following book. For fiction, include a brief plot overview, key themes, and major points or developments organized by chapter. For non-fiction, summarize the main arguments or topics covered by chapter and highlight the key takeaways. Give the output in strictly markdown format.
"""

prompt_research: str = """
Summarize this research paper by outlining:
- Research objectives/hypotheses
- Methodology used (study design/data sources)
- Key findings/results organized by section
- Limitations of the research
- Conclusions & implications for future work
Give the output in strictly markdown format.
"""

prompt_lecture: str = """
Convert this lecture transcript into an outline featuring:
- The main topic and learning objectives
- Key definitions/formulas introduced (italicized)
- Case studies/examples referenced
- Questions raised during Q&A session
- Connections to other topics in the field
Give the output in strictly markdown format.
"""

prompt_tutorial: str = """
Transform this technical guide into a structured summary:
- Core objective/task explained
- Prerequisites/tools required
- Step-by-step process overview (numbered list)
- Common pitfalls & troubleshooting tips
- Suggestions for further learning
Use markdown code blocks for commands/examples where applicable.
"""

prompt_interview: str = """
Condense this interview transcript into:
- Introducing the person being interviewed and their background
- Primary topics/themes covered
- Notable quotes from interviewee(s)
- Contextual insights about tone/subtext
- Key takeaways and actionable advice
Format as markdown with clear sections.
"""

prompt_debate: str = """
Analyze this debate by:
- Identifying the central question or topic of disagreement
- Summarizing the strongest arguments from each side in a balanced way
- Highlighting points of agreement and areas of fundamental disagreement
- Noting logical fallacies or rhetorical techniques used
- Providing a balanced conclusion about the state of the debate
Give the output in strictly markdown format.
"""

prompt_podcast: str = """
Summarize this podcast episode by identifying:
- Episode topic and guest information
- Main discussion segments with approximate timestamps
- Central arguments/theories proposed
- Resources/references mentioned
- Key takeaways and conclusions
Format in markdown using headers and bullet lists.
"""

prompt_legal: str = """
Analyze this legal document to extract:
- Parties involved & effective dates
- 3-5 most consequential clauses/sections
- Obligations per party (bullet-pointed)
- Termination conditions & penalties
- Potential risks or concerning clauses
Present as markdown with clear headers for sections.
"""

prompt_medical: str = """
Summarize this medical case study by organizing:
- Patient presentation (demographics & chief complaints)
- Diagnostic tests/results
- Treatment pathway and procedures
- Outcome at discharge/follow-up
- Learning points and recommendations for similar cases
Maintain clinical terminology while avoiding jargon overload in your markdown output.
"""

prompt_review: str = """
Synthesize this product review or multiple reviews into:
- Overall assessment and recommendation
- Key strengths and standout features
- Limitations, weaknesses, or concerns
- Comparison with alternatives (if mentioned)
- Ideal use cases or target users
Use markdown headers and formatting for clarity.
"""

prompt_project: str = """
Structure this project information as:
- Project overview and objectives
- Key stakeholders and responsibilities
- Timeline with milestones and deliverables
- Resource requirements and constraints
- Risk assessment and mitigation strategies
- Success metrics and evaluation criteria
Give the output in strictly markdown format.
"""

prompt_principles: str = """
focus on the higher level principles that can be derived from this, intead of the literal values: give me a list of potential areas of my life that these principles could be applied.
"""

prompt_general: str = """
Summarize the following input in a clear and concise manner, highlighting the most important points and main ideas for quick understanding. Give the output in strictly markdown format.
"""
prompt: str = ""


# Make sure we can handle encoding errors
try:
    # Define valid summary types
    SUMMARY_TYPES = ["meeting", "book", "research", "lecture", "tutorial",
                    "interview", "debate", "podcast", "legal", "medical",
                    "review", "project", "general", "custom"]

    # Parse args
    parser = argparse.ArgumentParser(description="Perform actions in different modes.")

    parser.add_argument("--type", choices=SUMMARY_TYPES,
                       required=False, help="Summary Type", default="")
    parser.add_argument("--principle", action="store_true", required=False, default=False, help="focus on princples instead of literal")
    parser.add_argument("--prompt", required=False, help="append this to the built-in prompt", default="")
    parser.add_argument("--debug", action="store_true", required=False, default=True, help="print debug logging")

    args = parser.parse_args()

    # Build prompt map dynamically
    if (True == args.debug):
        print("[DEBUG] Building prompt map from defined types", file=sys.stderr, flush=True)

    prompt_map = {
        "": prompt_general  # Default to general if empty
    }

    # Add each defined type to the map
    for type_name in SUMMARY_TYPES:
        if (True == args.debug):
            print(f"[DEBUG] Processing type: {type_name}", file=sys.stderr, flush=True)

        if type_name == "custom":
            prompt_map[type_name] = ""  # For custom type, we'll just use the args.prompt
            if (True == args.debug):
                print(f"[DEBUG] Added custom type with empty prompt", file=sys.stderr, flush=True)

        elif type_name == "general":
            prompt_map[type_name] = prompt_general
            if (True == args.debug):
                print(f"[DEBUG] Added general type with general prompt", file=sys.stderr, flush=True)

        else:
            # Get the prompt variable by name (e.g., prompt_meeting, prompt_book)
            prompt_var_name = f"prompt_{type_name}"
            if prompt_var_name in locals():
                prompt_map[type_name] = locals()[prompt_var_name]
                if (True == args.debug):
                    print(f"[DEBUG] Added {type_name} with {prompt_var_name}", file=sys.stderr, flush=True)
            else:
                if (True == args.debug):
                    print(f"[DEBUG] Warning: No prompt found for {type_name}", file=sys.stderr, flush=True)

    # Get the type, defaulting to general if not specified
    summary_type = args.type if args.type else "general"

    if (True == args.debug):
        print(f"[DEBUG] {summary_type} mode in use", file=sys.stderr, flush=True)

    # Get base prompt from map
    base_prompt = prompt_map.get(summary_type, prompt_general)

    # For custom type, we just use the provided prompt
    if summary_type == "custom":
        prompt = f"{args.prompt}\n"
    else:
        prompt = f"{base_prompt} {args.prompt}\n"

    if (True == args.principle):
        if (True == args.debug):
            print("[DEBUG] principles mode is in use", file=sys.stderr, flush=True)
        prompt = f"{prompt_principles} {prompt}"

    if (True == args.debug):
        print(f"[DEBUG] prompt:\n{prompt}", file=sys.stderr, flush=True)

    # Read content with error handling
    data_bytes = stdin.buffer.read()
    
    # Try to decode with UTF-8, replacing invalid characters
    data = data_bytes.decode('utf-8', errors='replace')
 
    # add the prompt and the data together
    query: str = f"{prompt}\n--------------------------\n{data}"
    
    # Run the AI processing command
    result = run(
        "perpy | mton",
        input=query.encode('utf-8'),
        shell=True,
        capture_output=True
    )
    
    # Print the result
    if result.returncode == 0:
        print(result.stdout.decode('utf-8', errors='replace'))
    else:
        # Handle error in perpy or mton
        print(f"* Error in AI processing\n\n{result.stderr.decode('utf-8', errors='replace')}")
        sys.exit(1)
        
except Exception as e:
    # Handle any other exceptions
    print(f"* Error in AI summary script\n\n{str(e)}")
    sys.exit(1)

