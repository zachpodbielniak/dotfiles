#!/usr/bin/python3 

import sys
import argparse                                                               
from sys import stdin, argv
from subprocess import run

# prompt_meeting: str = "below is a a transcript. summarize this into markdown format where various topics are split into different sections using bullet points. be sure to note any take aways (and who owns them if possible), any agreements that were had (if any), any lessons learned that were had (if any), and anything that can be improved (if any):\n"

prompt_meeting: str = """
Summarize the following meeting transcript by outlining:  
- The meeting agenda  
- Major discussion points, organized under relevant agenda sections and listed as bullet points  
- What decisions were agreed upon  
- Key takeaways from the meeting, specifying who owns each action item.
Give the output in strictly markdown format.
"""

prompt_book: str = """
Provide a comprehensive summary of the following book. For fiction, include a brief plot overview, key themes, and major points or developments organized by chapter. For non-fiction, summarize the main arguments or topics covered by chapter and highlight the key takeaways. Give the output in strictly markdown format.
"""

prompt_principles: str = """
focus on the higher level principles that can be derived from this, intead of the literal values: give me a list of potential areas of my life that these principles could be applied.
"""

prompt_general: str = """
Summarize the following input in a clear and concise manner, highlighting the most important points and main ideas for quick understanding. Give the output in strictly markdown format.
"""
prompt: str = ""


# Make sure we can handle encoding errors
try:
    # Parse args
    parser = argparse.ArgumentParser(description="Perform actions in different modes.")

    parser.add_argument("--type", choices=["meeting", "book", "general", "custom"], required=False, help="Summary Type", default="")
    parser.add_argument("--principle", action="store_true", required=False, default=False, help="focus on princples instead of literal")
    parser.add_argument("--prompt", required=False, help="append this to the built-in prompt", default="")
    parser.add_argument("--debug", action="store_true", required=False, default=True, help="print debug logging")

    args = parser.parse_args()

    if ("custom" == args.type):
        if (True == args.debug):
            print("[DEBUG] custom mode in use")
        prompt = f"{args.prompt}\n"

    elif ("meeting" == args.type):
        if (True == args.debug):
            print("[DEBUG] meeting mode in use")
        prompt = f"{prompt_meeting} {args.prompt}\n"

    elif ("book" == args.type):
        if (True == args.debug):
            print("[DEBUG] book mode in use")
        prompt = f"{prompt_book} {args.prompt}\n"

    elif ("general" == args.type or args.type == ""):
        if (True == args.debug):
            print("[DEBUG] general mode in use")
        prompt = f"{prompt_general} {args.prompt}\n"

    if (True == args.principle):
        if (True == args.debug):
            print("[DEBUG] principles mode is in use")
        prompt = f"{prompt_principles} {prompt}"

    if (True == args.debug):
        print(f"[DEBUG] prompt:\n{prompt}")

    # Read content with error handling
    data_bytes = stdin.buffer.read()
    
    # Try to decode with UTF-8, replacing invalid characters
    data = data_bytes.decode('utf-8', errors='replace')
 
    # add the prompt and the data together
    query: str = f"{prompt}\n--------------------------\n{data}"
    
    # Run the AI processing command
    result = run(
        "perpy | mton",
        input=query.encode('utf-8'),
        shell=True,
        capture_output=True
    )
    
    # Print the result
    if result.returncode == 0:
        print(result.stdout.decode('utf-8', errors='replace'))
    else:
        # Handle error in perpy or mton
        print(f"* Error in AI processing\n\n{result.stderr.decode('utf-8', errors='replace')}")
        sys.exit(1)
        
except Exception as e:
    # Handle any other exceptions
    print(f"* Error in AI summary script\n\n{str(e)}")
    sys.exit(1)

