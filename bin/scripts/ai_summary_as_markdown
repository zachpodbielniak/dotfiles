#!/usr/bin/python3 

import sys
from sys import stdin
from subprocess import run

# Make sure we can handle encoding errors
try:
    # Read content with error handling
    data_bytes = stdin.buffer.read()
    
    # Try to decode with UTF-8, replacing invalid characters
    data = data_bytes.decode('utf-8', errors='replace')
    
    prompt: str = "below is a a transcript. summarize this into markdown format where various topics are split into different sections using bullet points. be sure to note any take aways (and who owns them if possible), any agreements that were had (if any), any lessons learned that were had (if any), and anything that can be improved (if any):\n"
    
    query: str = f"{prompt}\n\n{data}"
    
    # Run the AI processing command
    result = run(
        "perpy",
        input=query.encode('utf-8'),
        shell=True,
        capture_output=True
    )
    
    # Print the result
    if result.returncode == 0:
        print(result.stdout.decode('utf-8', errors='replace'))
    else:
        # Handle error in perpy or mton
        print(f"* Error in AI processing\n\n{result.stderr.decode('utf-8', errors='replace')}")
        sys.exit(1)
        
except Exception as e:
    # Handle any other exceptions
    print(f"* Error in AI summary script\n\n{str(e)}")
    sys.exit(1)

