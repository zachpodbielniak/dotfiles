#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
group_by - Group lines and aggregate values

USAGE:
	group_by [OPTIONS]

OPTIONS:
	-h, --help          Show this help message
	--license           Show license information
	-d, --delimiter CH  Field delimiter (default: whitespace)
	-k, --key FIELD     Key field number (1-indexed, default: 1)
	-v, --value FIELD   Value field number (default: 2)
	--count             Count occurrences (ignores -v)
	--sum               Sum values
	--avg               Average values
	--min               Minimum value
	--max               Maximum value
	--list              List all values (comma-separated)

EXAMPLES:
	echo -e "a\na\nb" | group_by --count
	echo -e "a 10\na 20\nb 5" | group_by --sum
	echo -e "a:10\na:20" | group_by -d: --avg

DESCRIPTION:
	Group lines by key field and aggregate values using
	the specified aggregation function.

EOF
}

if [[ $# -lt 1 ]]; then
	usage >&2
	exit 1
fi

delimiter=" "
key_field=1
value_field=2
operation="count"

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		-d|--delimiter)
			delimiter="$2"
			shift 2
			;;
		-k|--key)
			key_field="$2"
			shift 2
			;;
		-v|--value)
			value_field="$2"
			shift 2
			;;
		--count)
			operation="count"
			shift
			;;
		--sum)
			operation="sum"
			shift
			;;
		--avg)
			operation="avg"
			shift
			;;
		--min)
			operation="min"
			shift
			;;
		--max)
			operation="max"
			shift
			;;
		--list)
			operation="list"
			shift
			;;
		*)
			echo "group_by: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Use awk to perform grouping and aggregation
awk -v FS="$delimiter" -v OFS="$delimiter" -v key=$key_field -v val=$value_field -v op="$operation" '
	{
		k = $key
		v = $val

		if (op == "count") {
			count[k]++
		} else if (op == "sum") {
			sum[k] += v
		} else if (op == "avg") {
			sum[k] += v
			count[k]++
		} else if (op == "min") {
			if (!(k in min) || v < min[k]) {
				min[k] = v
			}
		} else if (op == "max") {
			if (!(k in max) || v > max[k]) {
				max[k] = v
			}
		} else if (op == "list") {
			if (k in list) {
				list[k] = list[k] "," v
			} else {
				list[k] = v
			}
		}
	}
	END {
		if (op == "count") {
			for (k in count) print k, count[k]
		} else if (op == "sum") {
			for (k in sum) print k, sum[k]
		} else if (op == "avg") {
			for (k in sum) print k, sum[k]/count[k]
		} else if (op == "min") {
			for (k in min) print k, min[k]
		} else if (op == "max") {
			for (k in max) print k, max[k]
		} else if (op == "list") {
			for (k in list) print k, list[k]
		}
	}
'
