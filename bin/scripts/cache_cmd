#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
cache_cmd - Cache command output with TTL

USAGE:
	cache_cmd [OPTIONS] <ttl> <command>

OPTIONS:
	-h, --help              Show this help message
	--license               Show license information
	--clear                 Clear cache for this command
	--clear-all             Clear entire cache
	--cache-dir DIR         Custom cache directory (default: ~/.cache/cache_cmd)

EXAMPLES:
	cache_cmd 1h "curl https://api.example.com/slow"
	cache_cmd 30m "expensive_computation arg1"
	cache_cmd --clear "curl https://..."

EOF
}

cache_dir="${HOME}/.cache/cache_cmd"
clear_cache=false
clear_all=false
ttl=""
command=""

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--clear) clear_cache=true; shift ;;
		--clear-all) clear_all=true; shift ;;
		--cache-dir) cache_dir="${2}"; shift 2 ;;
		*)
			if [[ -z "$ttl" ]]; then
				ttl="${1}"
				shift
			elif [[ -z "$command" ]]; then
				command="${1}"
				shift
			else
				command="$command ${1}"
				shift
			fi
			;;
	esac
done

mkdir -p "$cache_dir"

if [[ "$clear_all" == true ]]; then
	rm -rf "$cache_dir"/*
	exit 0
fi

if [[ -z "$ttl" ]] || [[ -z "$command" ]]; then
	echo "Error: ttl and command required" >&2
	exit 1
fi

# Generate cache key from command
cache_key=$(echo "$command" | sha256sum | awk '{print $1}')
cache_file="$cache_dir/$cache_key"

if [[ "$clear_cache" == true ]]; then
	rm -f "$cache_file"
	exit 0
fi

# Parse TTL to seconds
parse_ttl () {
	local ttl="$1"
	if [[ "$ttl" =~ ^([0-9]+)(s|m|h|d)$ ]]; then
		local num="${BASH_REMATCH[1]}"
		local unit="${BASH_REMATCH[2]}"
		case "$unit" in
			s) echo "$num" ;;
			m) echo "$((num * 60))" ;;
			h) echo "$((num * 3600))" ;;
			d) echo "$((num * 86400))" ;;
		esac
	else
		echo "$ttl"  # assume seconds if no unit
	fi
}

ttl_seconds=$(parse_ttl "$ttl")

# Check if cache exists and is fresh
if [[ -f "$cache_file" ]]; then
	file_time=$(stat -c %Y "$cache_file")
	current_time=$(date +%s)
	age=$((current_time - file_time))

	if [[ $age -lt $ttl_seconds ]]; then
		cat "$cache_file"
		exit 0
	fi
fi

# Cache miss or expired - execute command and cache result
eval "$command" | tee "$cache_file"
