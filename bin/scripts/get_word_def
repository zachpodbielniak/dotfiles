#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

declare -a words

# if no args read from stdin
if [ ${#} -eq 0 ]; then
    while IFS= read -r entry
    do 
        words+=("${entry}")
    done
else
    # shift arg by arg and append to the words
    while [[ ${#} -gt 0 ]]
    do 
        words+=("${1}")
        shift
    done
fi

# check word
if [[ "${words}" == "" ]]
then 
    echo "Usage: ${0} <word0> <word1>...<wordn>"
    echo "or"
    echo "echo <word0> <word1>...<wordn> | ${0}"
    exit 1
fi


# pass in word as arg 1
get_single_def() {
    local word="${1}"

    # do api call
    web_request=$(curl --silent "https://api.dictionaryapi.dev/api/v2/entries/en/${word}")

    # check for yq/jq and use whichever for output
    if [[ $(type yq 2>/dev/null >/dev/null) -eq 0 ]]
    then
        defs=$(yq -p json .[].meanings[].definitions[].definition <<< "${web_request}")
    elif [[ $(type jq 2>/dev/null >/dev/null) -eq 0 ]]
    then 
        defs=$(jq .[].meanings[].definitions[].definition <<< "${web_request}")
    else 
        echo "${0} requires yq or jq. install either"
        exit 1
    fi

    # parse the yq/jq output and format it in md/norg friendly format
    echo "${word}:"
    while read -r line; do
        quotes_removed=$(sed 's/"//g' <<< ${line})
        echo "- ${quotes_removed}"
    done <<< "${defs}"
    echo "" 
}

# iterate all words
for word in ${words[@]}
do 
    get_single_def "${word}"
done

