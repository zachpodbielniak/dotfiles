#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
str_replace - Replace substring in input

USAGE:
str_replace [OPTIONS] PATTERN REPLACEMENT

OPTIONS:
-h, --help        Show this help message
--license         Show license information
-g, --global      Replace all occurrences (default: first only)
-i, --ignore-case Case-insensitive matching

EXAMPLES:
echo "hello world" | str_replace "hello" "goodbye"
# Output: goodbye world

echo "aaa" | str_replace -g "a" "b"
# Output: bbb

echo "Hello" | str_replace -i "hello" "hi"
# Output: hi

EOF
}

if [[ $# -lt 2 ]]; then
	echo "str_replace: missing arguments" >&2
	usage >&2
	exit 1
fi

global_replace=0
ignore_case=0

# Parse options
while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		-g|--global) global_replace=1; shift ;;
		-i|--ignore-case) ignore_case=1; shift ;;
		-*)
			echo "Unknown option: ${1}" >&2
			usage >&2
			exit 1
			;;
		*)
			# First non-option arguments are pattern and replacement
			break
			;;
	esac
done

pattern="${1:-}"
replacement="${2:-}"

if [[ -z "${pattern}" ]] || [[ -z "${replacement}" ]]; then
	echo "str_replace: PATTERN and REPLACEMENT required" >&2
	usage >&2
	exit 1
fi

# Build sed expression
if [[ $ignore_case -eq 1 ]]; then
	if [[ $global_replace -eq 1 ]]; then
		# Global case-insensitive
		sed "s/${pattern}/${replacement}/gi"
	else
		# First only, case-insensitive
		sed "s/${pattern}/${replacement}/i"
	fi
else
	if [[ $global_replace -eq 1 ]]; then
		# Global case-sensitive
		sed "s/${pattern}/${replacement}/g"
	else
		# First only, case-sensitive
		sed "s/${pattern}/${replacement}/"
	fi
fi
