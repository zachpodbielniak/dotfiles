#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

# Get current year
YEAR=$(date +%Y)
AUTHOR="Zach Podbielniak"  # Update this with your full name if desired

# License headers for different languages
SHELL_LICENSE_HEADER="# dotfiles - Personal configuration files and scripts
# Copyright (C) $YEAR  $AUTHOR
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>."

PYTHON_LICENSE_HEADER="# dotfiles - Personal configuration files and scripts
# Copyright (C) $YEAR  $AUTHOR
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>."

PERL_LICENSE_HEADER="# dotfiles - Personal configuration files and scripts
# Copyright (C) $YEAR  $AUTHOR
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>."

HASKELL_LICENSE_HEADER="{-
dotfiles - Personal configuration files and scripts
Copyright (C) $YEAR  $AUTHOR

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-}"

# Function to get the shebang line
get_shebang() {
    local file="$1"
    head -n1 "$file" 2>/dev/null || echo ""
}

# Function to check if file has a license mention
has_license() {
    local file="$1"
    # Look for actual license text, not just the words
    grep -i -E "(^#.*license|^#.*copyright|^#.*Licensed under|^#.*This program is free software|^#.*GPL|^#.*MIT License|^#.*BSD License|^#.*Apache License)" "$file" >/dev/null 2>&1
}

# Function to determine file type
get_file_type() {
    local file="$1"
    local shebang=$(get_shebang "$file")
    
    if [[ "$shebang" =~ python ]]; then
        echo "python"
    elif [[ "$shebang" =~ perl ]]; then
        echo "perl"
    elif [[ "$shebang" =~ runghc|runhaskell ]] || [[ "$file" =~ \.hs$ ]]; then
        echo "haskell"
    elif [[ "$shebang" =~ bash|sh ]]; then
        echo "shell"
    elif [[ "$file" =~ \.py$ ]]; then
        echo "python"
    elif [[ "$file" =~ \.pl$ ]]; then
        echo "perl"
    elif [[ "$file" =~ \.sh$ ]]; then
        echo "shell"
    else
        echo "shell"  # default to shell
    fi
}

# Function to add license header to a file
add_license_header() {
    local file="$1"
    local filetype=$(get_file_type "$file")
    local header=""
    
    case "$filetype" in
        python)
            header="$PYTHON_LICENSE_HEADER"
            ;;
        perl)
            header="$PERL_LICENSE_HEADER"
            ;;
        haskell)
            header="$HASKELL_LICENSE_HEADER"
            ;;
        shell)
            header="$SHELL_LICENSE_HEADER"
            ;;
        *)
            header="$SHELL_LICENSE_HEADER"
            ;;
    esac
    
    # Create temp file
    local tmpfile=$(mktemp)
    
    # Get shebang if exists
    local shebang=$(get_shebang "$file")
    
    if [ -n "$shebang" ] && [[ "$shebang" =~ ^#! ]]; then
        # File has shebang
        echo "$shebang" > "$tmpfile"
        echo "" >> "$tmpfile"
        echo "$header" >> "$tmpfile"
        echo "" >> "$tmpfile"
        # Add rest of file skipping the shebang
        tail -n +2 "$file" >> "$tmpfile"
    else
        # No shebang
        echo "$header" > "$tmpfile"
        echo "" >> "$tmpfile"
        cat "$file" >> "$tmpfile"
    fi
    
    # Replace original file
    mv "$tmpfile" "$file"
}

# Function to update existing license
update_license() {
    local file="$1"
    local filetype=$(get_file_type "$file")
    local header=""
    
    case "$filetype" in
        python)
            header="$PYTHON_LICENSE_HEADER"
            ;;
        perl)
            header="$PERL_LICENSE_HEADER"
            ;;
        haskell)
            header="$HASKELL_LICENSE_HEADER"
            ;;
        shell)
            header="$SHELL_LICENSE_HEADER"
            ;;
        *)
            header="$SHELL_LICENSE_HEADER"
            ;;
    esac
    
    # Create temp file
    local tmpfile=$(mktemp)
    
    # Get shebang if exists
    local shebang=$(get_shebang "$file")
    
    # Flag to track if we're in a license block
    local in_license=0
    local license_replaced=0
    local line_num=0
    
    while IFS= read -r line; do
        line_num=$((line_num + 1))
        
        # Skip shebang
        if [ $line_num -eq 1 ] && [[ "$line" =~ ^#! ]]; then
            echo "$line" >> "$tmpfile"
            continue
        fi
        
        # Detect start of license block
        if [ $in_license -eq 0 ] && [[ "$line" =~ (license|copyright|Licensed|Copyright) ]] && [[ "$line" =~ ^# ]]; then
            in_license=1
            # Write new license header once
            if [ $license_replaced -eq 0 ]; then
                echo "" >> "$tmpfile"
                echo "$header" >> "$tmpfile"
                echo "" >> "$tmpfile"
                license_replaced=1
            fi
            continue
        fi
        
        # Skip lines in license block
        if [ $in_license -eq 1 ]; then
            # Check if we're still in comment block
            if [[ "$line" =~ ^# ]] || [ -z "$line" ]; then
                continue
            else
                # End of license block
                in_license=0
            fi
        fi
        
        # Write non-license lines
        if [ $in_license -eq 0 ]; then
            echo "$line" >> "$tmpfile"
        fi
    done < "$file"
    
    # Replace original file
    mv "$tmpfile" "$file"
}

# Main processing
echo "Updating licenses in bin/scripts..."

for file in *; do
    # Skip directories and this script
    if [ -d "$file" ] || [ "$file" = "update_licenses.sh" ]; then
        continue
    fi
    
    # Skip if it's not a regular file
    if [ ! -f "$file" ]; then
        continue
    fi
    
    echo -n "Processing $file... "
    
    if has_license "$file"; then
        echo "updating existing license"
        update_license "$file"
    else
        echo "adding new license"
        add_license_header "$file"
    fi
done

echo "License update complete!"
