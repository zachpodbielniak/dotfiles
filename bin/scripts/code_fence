#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

SCRIPT_NAME="$(basename "${0}")"

usage () {
    cat <<EOF
${SCRIPT_NAME} - Wrap selection in markdown code fence with language detection

USAGE:
    ${SCRIPT_NAME} [OPTIONS] [FILE]

DESCRIPTION:
    Wraps the input in a markdown code fence (\`\`\`). Attempts to detect
    the programming language from content patterns, or accepts explicit lang.

OPTIONS:
    -h, --help          Show this help message and exit
    -l, --lang LANG     Specify language explicitly (skips detection)
    -u, --unwrap        Remove code fence instead of adding
    --license           Show the license (AGPLv3) and exit

ARGUMENTS:
    FILE            Optional file path to read content from.
                    If not provided, reads from stdin.

EXAMPLES:
    # Auto-detect language
    echo 'def hello(): print("hi")' | ${SCRIPT_NAME}

    # Specify language
    echo 'SELECT * FROM users;' | ${SCRIPT_NAME} -l sql

    # Unwrap existing fence
    echo -e '\`\`\`python\\nprint("hi")\\n\`\`\`' | ${SCRIPT_NAME} -u

    # Use in neovim
    :'<,'>!${SCRIPT_NAME}

EOF
}

detect_language () {
    local content="${1}"
    
    # Check for shebang
    if [[ "${content}" =~ ^#!.*python ]]; then echo "python"; return; fi
    if [[ "${content}" =~ ^#!.*bash ]] || [[ "${content}" =~ ^#!.*\/sh ]]; then echo "bash"; return; fi
    if [[ "${content}" =~ ^#!.*node ]] || [[ "${content}" =~ ^#!.*deno ]]; then echo "javascript"; return; fi
    if [[ "${content}" =~ ^#!.*ruby ]]; then echo "ruby"; return; fi
    if [[ "${content}" =~ ^#!.*perl ]]; then echo "perl"; return; fi

    # Check for language patterns
    # Python
    if [[ "${content}" =~ (^|\n)(def |class |import |from .* import |if __name__) ]]; then echo "python"; return; fi
    # JavaScript/TypeScript
    if [[ "${content}" =~ (const |let |function |=\>|module\.exports|import .* from) ]]; then
        if [[ "${content}" =~ (: string|: number|: boolean|interface |type ) ]]; then
            echo "typescript"; return
        fi
        echo "javascript"; return
    fi
    # Rust
    if [[ "${content}" =~ (fn |impl |struct |enum |use |mod |pub |let mut ) ]]; then echo "rust"; return; fi
    # Go
    if [[ "${content}" =~ (^|\n)(package |func |import \(|type .* struct) ]]; then echo "go"; return; fi
    # C/C++
    if [[ "${content}" =~ (#include|int main|void |printf\(|std::) ]]; then echo "c"; return; fi
    # Java
    if [[ "${content}" =~ (public class |private |protected |System\.out) ]]; then echo "java"; return; fi
    # SQL
    if [[ "${content}" =~ (SELECT |INSERT |UPDATE |DELETE |CREATE TABLE|DROP ) ]]; then echo "sql"; return; fi
    # YAML
    if [[ "${content}" =~ ^[a-zA-Z_]+:[[:space:]] ]]; then echo "yaml"; return; fi
    # JSON
    if [[ "${content}" =~ ^\{.*\}$ ]] || [[ "${content}" =~ ^\[.*\]$ ]]; then echo "json"; return; fi
    # HTML
    if [[ "${content}" =~ \<(html|head|body|div|span|p|a |script|style) ]]; then echo "html"; return; fi
    # CSS
    if [[ "${content}" =~ \{[^}]*(color:|background:|margin:|padding:) ]]; then echo "css"; return; fi
    # Markdown
    if [[ "${content}" =~ (^|\n)(#+ |^\*\*|^\- \[) ]]; then echo "markdown"; return; fi
    # Bash (if has shell-like constructs)
    if [[ "${content}" =~ (^|\n)(if \[\[|for .* in|while |done|fi$|esac$|\$\() ]]; then echo "bash"; return; fi

    # Default: no language
    echo ""
}

main () {
    local lang=""
    local unwrap=0
    local file_path=""

    while [[ $# -gt 0 ]]; do
        case "${1}" in
            -h|--help)
                usage
                exit 0
                ;;
            -l|--lang)
                lang="${2}"
                shift
                ;;
            -u|--unwrap)
                unwrap=1
                ;;
            --license)
                echo "AGPLv3 - See source file for full license."
                exit 0
                ;;
            -*)
                echo "Error: Unknown option '${1}'" >&2
                exit 1
                ;;
            *)
                file_path="${1}"
                ;;
        esac
        shift
    done

    local content
    if [[ -n "${file_path}" ]]; then
        content=$(cat "${file_path}")
    else
        content=$(cat)
    fi

    if [[ ${unwrap} -eq 1 ]]; then
        # Remove code fence
        echo "${content}" | sed -E '1{/^```/d}; ${/^```$/d}'
    else
        # Add code fence
        if [[ -z "${lang}" ]]; then
            lang=$(detect_language "${content}")
        fi
        echo "\`\`\`${lang}"
        echo "${content}"
        echo "\`\`\`"
    fi
}

main "$@"
