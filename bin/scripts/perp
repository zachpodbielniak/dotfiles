#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.


function call_perplexity() {
    local json_request
    json_request=$(jq -n \
		--arg content "$*" \
		'{
      "model": "sonar-pro",
      "messages": [
        { "role": "system",  "content": "Be precise and concise." },
        { "role": "user",  "content": $content }
      ],
      "stream": false
    }')
    # echo $json_request # uncomment to debug
    
    local json_response
    json_response=$(curl --silent \
		--request POST \
		--url https://api.perplexity.ai/chat/completions \
		--header 'accept: application/json' \
		--header "authorization: Bearer $PERPLEXITY_TOKEN" \
		--header 'content-type: application/json' \
		--data "$json_request")
    # echo $json_response  # uncomment to debug

    echo "$json_response" | jq --raw-output .choices[0].message.content
}


if [ "$#" -eq 0 ]; then
    tokens=()
    
    while IFS= read -r line 
    do 
        tokens+=("${line}")
    done
    
    call_perplexity "${tokens[@]}"
else
    call_perplexity "${@}"
fi

