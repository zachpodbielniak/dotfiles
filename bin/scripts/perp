#!/bin/bash

function call_perplexity() {
    local json_request
    json_request=$(jq -n \
		--arg content "$*" \
		'{
      "model": "llama-3.1-sonar-huge-128k-online",
      "messages": [
        { "role": "system",  "content": "Be precise and concise." },
        { "role": "user",  "content": $content }
      ],
      "stream": false
    }')
    # echo $json_request # uncomment to debug
    
    local json_response
    json_response=$(curl --silent \
		--request POST \
		--url https://api.perplexity.ai/chat/completions \
		--header 'accept: application/json' \
		--header "authorization: Bearer $PERPLEXITY_TOKEN" \
		--header 'content-type: application/json' \
		--data "$json_request")
    # echo $json_response  # uncomment to debug

    echo "$json_response" | jq --raw-output .choices[0].message.content
}


if [ "$#" -eq 0 ]; then
    tokens=()
    
    while IFS= read -r line 
    do 
        tokens+=("${line}")
    done
    
    call_perplexity "${tokens[@]}"
else
    call_perplexity "${@}"
fi

