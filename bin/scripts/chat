#!/bin/bash
# Helper script to wrap calling neovim to pass context to chat models
set -euo pipefail 

# default chat operation
chat_command=":PrtChatToggle"

print_help() {
    echo -e "Usage: $(basename ${0}) <args>"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -n,--new\tcreate a new chat instead of opening the most recent"
    echo -e "  -f,--find\tfind a chat instead of opening the most recent"
}

while [[ $# -gt 0 ]]
do 
    case "${1}" in 
    -h|--help)
        print_help
        exit 0
        ;;
    -n|--new)
        chat_command=":PrtChatNew"
        ;;
    -f|--find)
        chat_command=":PrtChatFinder"
        ;;
    esac
    shift
done

# Check that stdin is not a tty which means
# its a file/pipe
# not supported for --find
if [[ ! -t 0 ]] && [[ "${chat_command}" != ":PrtChatFinder" ]]
then
    data=""

    while IFS= read -r line
    do
        data="$(printf "%s\n%s" "${data}" "${line}")"
    done

    exec nvim - -c "normal ggVGy" -c "${chat_command}" -c "normal P" <<< "${data}"
fi

# otherwise we just call it without reading from stdin
exec nvim -c "${chat_command}"

