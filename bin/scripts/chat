#!/bin/bash

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# Helper script to wrap calling neovim to pass context to chat models
set -euo pipefail 

# default chat operation
chat_command=":PrtChatToggle"

print_help() {
    echo -e "Usage: $(basename ${0}) <args>"
    echo -e "  -h,--help\tprint this message"
    echo -e "  -n,--new\tcreate a new chat instead of opening the most recent"
    echo -e "  -f,--find\tfind a chat instead of opening the most recent"
}

while [[ $# -gt 0 ]]
do 
    case "${1}" in 
    -h|--help)
        print_help
        exit 0
        ;;
    -n|--new)
        chat_command=":PrtChatNew"
        ;;
    -f|--find)
        chat_command=":PrtChatFinder"
        ;;
    esac
    shift
done

# Check that stdin is not a tty which means
# its a file/pipe
# not supported for --find
if [[ ! -t 0 ]] && [[ "${chat_command}" != ":PrtChatFinder" ]]
then
    data=""

    while IFS= read -r line
    do
        data="$(printf "%s\n%s" "${data}" "${line}")"
    done

    exec nvim - -c "normal ggVGy" -c "${chat_command}" -c "normal P" <<< "${data}"
fi

# otherwise we just call it without reading from stdin
exec nvim -c "${chat_command}"

