#!/usr/bin/python3 

from os import environ
from subprocess import run
from sys import argv, exit, stdin


ctr_id: str|None = ""
api_key: str|None = ""
query: str = ""
result: str = ""

if ("CONTAINER_ID" in environ):
    ctr_id = environ.get("CONTAINER_ID")

# if we are not in the 'dev' distrobox re-exec the script
# inside of the 'dev' distrobox
if ("dev" != ctr_id):
    cmd: list[str] = [
        "distrobox",
        "enter",
        "dev",
        "--",
        *argv
    ]
    
    run(cmd)
    exit(0)

if ("PERPLEXITY_TOKEN" in environ):
    api_key = environ.get("PERPLEXITY_TOKEN")
else:
    print("PERPLEXITY_TOKEN is not set")
    exit(1)

# Since outside of the distrobox we may not have these modules
# quietly ignore the fact that they may not exist
try:
    from perplexipy import PerplexityClient
    client: PerplexityClient
    client = PerplexityClient(key=api_key)
    client.model = "sonar-pro"
except ImportError:
    pass

# read from standard in
if (1 == len(argv)):
    query = stdin.read()
else:
    i: int = 1
    while (i < len(argv)):
        query = f"{query} {argv[i]}"
        i = i + 1

results = client.queryStreamable(query)
for result in results:
    # flush since it may not have a '\n' to give it 
    # a streaming output appearance
    print(result, end="", flush=True)

