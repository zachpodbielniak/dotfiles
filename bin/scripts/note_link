#!/bin/bash 

# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.


NOTES_DIR="$HOME/Documents/notes"
LEADER=""

if [[ $# -lt 1 ]]; then 
    echo "Use this tool correctly!"
    echo "$0 <tag> [leader]"
fi

SEARCH="$1"

if [[ $# -ge 2 ]]; then 
    LEADER="$2"
fi

pushd "${PWD}" >/dev/null 2>/dev/null || return
cd "${NOTES_DIR}" || return
all_notes=$(find . -name '*.md')

while read -r filename;
do 
    header=""
    while read -r line;
    do 
        count=0 
        # Safety net
        if [[ $count -gt 20 ]]; then break; fi
        # Reached end of metadata
        if [[ $line =~ @end ]]; then break; fi

        header="$header\n$line"
        ((count+=1))
    done < "$filename"

    has_tag=$(grep "${SEARCH}$" <(echo -e "${header}") | grep -vP "https?://" | grep -v "description:" | grep -v "title:")

    if [[ "" != "$has_tag" ]]; then 
        if [[ "" != "$LEADER" ]]; then 
            description=$(grep "description:" "${filename}")
            echo "$LEADER [${description:13}]{:${filename:2}:}"
        else 
            description=$(grep "description:" "${filename}")
            echo "[${description:13}]{:${filename:2}:}"
        fi
    fi

done <<< "$all_notes"
popd >/dev/null 2>/dev/null || return

