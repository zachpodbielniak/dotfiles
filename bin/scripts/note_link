#!/bin/bash 

NOTES_DIR="$HOME/Documents/notes"
LEADER=""

if [[ $# -lt 1 ]]; then 
    echo "Use this tool correctly!"
    echo "$0 <tag> [leader]"
fi

SEARCH="$1"

if [[ $# -ge 2 ]]; then 
    LEADER="$2"
fi

pushd "${PWD}" >/dev/null 2>/dev/null || return
cd "${NOTES_DIR}" || return
all_notes=$(find . -name '*.norg')

while read -r filename;
do 
    header=""
    while read -r line;
    do 
        count=0 
        # Safety net
        if [[ $count -gt 20 ]]; then break; fi
        # Reached end of metadata
        if [[ $line =~ @end ]]; then break; fi

        header="$header\n$line"
        ((count+=1))
    done < "$filename"

    has_tag=$(grep "${SEARCH}$" <(echo -e "${header}") | grep -vP "https?://" | grep -v "description:" | grep -v "title:")

    if [[ "" != "$has_tag" ]]; then 
        if [[ "" != "$LEADER" ]]; then 
            description=$(grep "description:" "${filename}")
            echo "$LEADER [${description:13}]{:${filename:2}:}"
        else 
            description=$(grep "description:" "${filename}")
            echo "[${description:13}]{:${filename:2}:}"
        fi
    fi

done <<< "$all_notes"
popd >/dev/null 2>/dev/null || return

