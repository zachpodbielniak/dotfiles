#!/usr/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2025  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
random_line - Pick random line(s) from input

USAGE:
	random_line [OPTIONS]

OPTIONS:
	-h, --help      Show this help message
	--license       Show license information
	-n, --count N   Number of lines to pick (default: 1)
	--seed N        Random seed for reproducibility

EXAMPLES:
	echo -e "a\nb\nc" | random_line
	echo -e "a\nb\nc\nd\ne" | random_line -n 3
	echo -e "a\nb\nc" | random_line --seed 42

DESCRIPTION:
	Randomly select one or more lines from stdin.
	Use --seed for reproducible randomness.

EOF
}

count=1
seed=""

while [[ $# -gt 0 ]]; do
	case "$1" in
		-h|--help)
			usage
			exit 0
			;;
		--license)
			echo "AGPLv3"
			exit 0
			;;
		-n|--count)
			count="$2"
			shift 2
			;;
		--seed)
			seed="$2"
			shift 2
			;;
		*)
			echo "random_line: unknown option: $1" >&2
			exit 1
			;;
	esac
done

# Use shuf if available, otherwise use awk
if command -v shuf &>/dev/null; then
	if [[ -n "$seed" ]]; then
		shuf --random-source=<(yes "$seed") -n "$count"
	else
		shuf -n "$count"
	fi
else
	# Fallback using awk
	if [[ -n "$seed" ]]; then
		awk -v seed="$seed" -v count="$count" '
			BEGIN { srand(seed) }
			{
				r = rand()
				lines[NR] = $0
			}
			END {
				for (i = 1; i <= count && i <= NR; i++) {
					idx = int(rand() * NR) + 1
					print lines[idx]
				}
			}
		'
	else
		awk -v count="$count" '
			{
				lines[NR] = $0
			}
			END {
				for (i = 1; i <= count && i <= NR; i++) {
					idx = int(rand() * NR) + 1
					print lines[idx]
				}
			}
		'
	fi
fi
