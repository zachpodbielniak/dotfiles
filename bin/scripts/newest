#!/bin/bash
# dotfiles - Personal configuration files and scripts
# Copyright (C) 2024  Zach Podbielniak
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

set -euo pipefail

usage () {
	cat << 'EOF'
newest - Find newest file(s) in directory

USAGE:
	newest [OPTIONS] <directory> [count]

OPTIONS:
	-h, --help          Show this help message
	--license           Show license information
	--recursive         Search subdirectories
	--type f|d          Files (f) or directories (d) only

EXAMPLES:
	newest ~/Downloads
	newest ~/logs 5
	newest ~/docs --recursive --type f

EOF
}

recursive=false
type_filter=""
count=1

while [[ $# -gt 0 ]]; do
	case "${1}" in
		-h|--help) usage; exit 0 ;;
		--license) echo "AGPLv3"; exit 0 ;;
		--recursive) recursive=true; shift ;;
		--type) type_filter="${2}"; shift 2 ;;
		*)
			if [[ -z "${dir:-}" ]]; then
				dir="${1}"
				shift
			elif [[ -z "${count:-}" ]]; then
				count="${1}"
				shift
			else
				echo "Error: unexpected argument '$1'" >&2
				exit 1
			fi
			;;
	esac
done

if [[ -z "${dir:-}" ]]; then
	echo "Error: directory argument required" >&2
	exit 1
fi

if [[ ! -d "$dir" ]]; then
	echo "Error: directory not found: $dir" >&2
	exit 1
fi

# Build find command
find_cmd="find \"$dir\""
[[ "$recursive" == false ]] && find_cmd="$find_cmd -maxdepth 1"

if [[ -n "$type_filter" ]]; then
	case "$type_filter" in
		f) find_cmd="$find_cmd -type f" ;;
		d) find_cmd="$find_cmd -type d" ;;
		*) echo "Error: invalid type '$type_filter'" >&2; exit 1 ;;
	esac
else
	find_cmd="$find_cmd -type f"
fi

# Sort by modification time (newest first) and get count
eval "$find_cmd" | head -1 > /dev/null 2>&1 || true
eval "$find_cmd -printf '%T@ %p\n'" | sort -rn | head -"$count" | cut -d' ' -f2-
