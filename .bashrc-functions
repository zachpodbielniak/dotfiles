#!/bin/bash


make_export () {
    [ "$#" != 1 ] && echo "$0 <bin>" && exit 1
    local export_dir="$HOME/bin/export"
    local bin_to_export="$1"
    mkdir -p "${export_dir}"
    if [ -f "${export_dir}/${bin_to_export}" ]; then rm "${export_dir}/${bin_to_export}"; fi
    distrobox-export --bin $(which "${bin_to_export}") --export-path "${export_dir}/"
}


make_app () {
    [ "$#" != 1 ] && echo "$0 <app>" && exit 1
    distrobox-export --app "$1"
}



function fr() {
    [ "$#" != 1 ] && echo "Usage: fr <app_name>" && exit 1
    local app="$1"

    flatpak run $(flatpak search "$app" --columns application | grep -v "Application\ ID")
}




in_container() {
    [ -f /run/.containerenv ] && echo 1 || echo 0
}

get_current_container_name() {
    local in_c=$(in_container)
    if [ "1" == "$in_c" ]; then
        cat /run/.containerenv | grep -i name | awk -F= '{printf "%s\n", $2}' | sed 's/\"//g'
    else
        echo "0"
    fi
}



ebsearch() {
    [ $# -eq 0 ] && echo "Usage: $0 <pcre_query>" && return 1
    rg -P $1 ~/Documents/E-Books/
}

function nonzero_return() {
    RETVAL=$?
    [ $RETVAL -ne 0 ] && echo "$RETVAL"
}

# get current branch in git repo
function parse_git_branch() {
    BRANCH=$(git branch 2>/dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/')
    if [ ! "${BRANCH}" == "" ]; then
        STAT=$(parse_git_dirty)
        echo "[${BRANCH}${STAT}]"
    else
        echo ""
    fi
}

# get current status of git repo
function parse_git_dirty {
    status=$(git status 2>&1 | tee)
    dirty=$(
        echo -n "${status}" 2>/dev/null | grep "modified:" &>/dev/null
        echo "$?"
    )
    untracked=$(
        echo -n "${status}" 2>/dev/null | grep "Untracked files" &>/dev/null
        echo "$?"
    )
    ahead=$(
        echo -n "${status}" 2>/dev/null | grep "Your branch is ahead of" &>/dev/null
        echo "$?"
    )
    newfile=$(
        echo -n "${status}" 2>/dev/null | grep "new file:" &>/dev/null
        echo "$?"
    )
    renamed=$(
        echo -n "${status}" 2>/dev/null | grep "renamed:" &>/dev/null
        echo "$?"
    )
    deleted=$(
        echo -n "${status}" 2>/dev/null | grep "deleted:" &>/dev/null
        echo "$?"
    )
    bits=''
    if [ "${renamed}" == "0" ]; then
        bits=">${bits}"
    fi
    if [ "${ahead}" == "0" ]; then
        bits="*${bits}"
    fi
    if [ "${newfile}" == "0" ]; then
        bits="+${bits}"
    fi
    if [ "${untracked}" == "0" ]; then
        bits="?${bits}"
    fi
    if [ "${deleted}" == "0" ]; then
        bits="x${bits}"
    fi
    if [ "${dirty}" == "0" ]; then
        bits="!${bits}"
    fi
    if [ ! "${bits}" == "" ]; then
        echo " ${bits}"
    else
        echo ""
    fi
}

# Power Related
function on_battery_power() {
    upower -d | grep -i on-battery | awk '{printf "%s", $2}'
}

function get_power_profile() {
    powerprofilesctl get
}

function list_power_profiles() {
    powerprofilesctl list
}

function set_power_profile() {
    local prof="$1"
    [ "" == "$prof" ] && echo "Usage: $0 <profile_name>" && exit 1
    powerprofilesctl set "$prof"
}

function set_appropriate_power_profile() {
    local power=$(on_battery_power)
    if [ "no" == "$power" ]; then
        echo "Setting power profile to performance"
        set_power_profile performance
    else
        echo "Setting power profile to power-saver"
        set_power_profile power-saver
    fi
}

function update_k8s_cluster() {
    local HOSTS=("kube-00.podbielniak.com" "kube-01.podbielniak.com" "kube-02.podbielniak.com")
    for host in ${HOSTS[@]}; do ssh $host sudo dnf update --refresh -y; done
    for host in ${HOSTS[@]}; do ssh $host sudo systemctl restart kubelet && sleep 15; done
}


function fr () {
	[ "$#" != 1 ] && echo "Usage: fr <app_name>" && exit 1
	local app="$1"

	flatpak run $(flatpak search "$app" --columns application | grep -v "Application\ ID")
}


in_container () { 
	[ -f /run/.containerenv ] && echo 1 || echo 0
}


get_current_container_name () {
	local in_c=$(in_container)
	if [ "1" == "$in_c" ] 
	then
		cat /run/.containerenv | grep -i name | awk -F= '{printf "%s\n", $2}' | sed 's/\"//g'
	else
		echo "0"
	fi
}


git_daily() {
    git commit -m "chore(daily): $(date +'%Y-%m-%d')" && git push
}

