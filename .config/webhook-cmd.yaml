# Webhook Command Runner Configuration
# This file configures webhook endpoints and their associated commands

# Webhook definitions
webhooks:
  # Example webhook that runs multiple commands in parallel
  /echo-test:
    commands:
    - 'echo "Received webhook at $(date): $WEBHOOK_PAYLOAD" >> /tmp/webhook-echo.log'
    - 'echo "Webhook received" | tee /tmp/webhook-status.log'
    description: 'Test webhook that echoes the payload'
    # runs_on_hostname: ['hostname1', 'hostname2']  # Optional: restrict to specific hosts

  # Example webhook that logs to multiple files
  /log-webhook:
    commands:
    - 'echo "[$(date)] Webhook received: $WEBHOOK_PAYLOAD" >> /tmp/webhook.log'
    - 'echo "[$(date)] Headers: $WEBHOOK_HEADERS" >> /tmp/webhook-headers.log'
    description: 'Logs webhook payload and headers to files'

  # Doorbell (comes from unifi and runs on a specific host)
  /doorbell-ring:
    commands: 
    - 'echo "[$(date)] Doorbell rang: $WEBHOOK_HEADERS -- $WEBHOOK_PAYLOAD" >> /tmp/webhook-doorbell.log'
    - 'ssh lt-zach DISPLAY=:0 mpv rtsps://10.0.0.1:7441/LwCOnMwfokHtwgKS?enableSrtp'
    runs_on_hostname:
    - 'srv-zach'
    whitelist:
    - '10.0.0.1'

  # Example webhook that processes JSON in parallel
  # /process-json:
  #   commands:
  #   - 'echo "$WEBHOOK_PAYLOAD" | jq "." > /tmp/last-webhook.json'
  #   - 'echo "$WEBHOOK_PAYLOAD" | jq ".timestamp = now" > /tmp/timestamped-webhook.json'
  #   - 'echo "JSON processed at $(date)" >> /tmp/webhook-process.log'
  #   description: 'Processes JSON payload in multiple ways'

  # Example webhook with hostname restriction
  # /deploy-local:
  #   commands:
  #   - 'echo "Starting deployment: $WEBHOOK_PAYLOAD" >> /tmp/deploy.log'
  #   - 'sleep 5 && echo "Deployment completed" >> /tmp/deploy.log'
  #   description: 'Local deployment webhook'
  #   runs_on_hostname: ['silverblue', 'dev-machine']
  #   whitelist: 
  #   - '10.0.0.0/8'  # Only allow from internal network

  # Example webhook that sends a notification
  # /notify:
  #   commands:
  #   - 'notify-send "Webhook Received" "$WEBHOOK_PAYLOAD"'
  #   - 'echo "Notification sent at $(date)" >> /tmp/notifications.log'
  #   description: 'Send desktop notification with payload'

  # Example single command (backward compatible)
  # /simple:
  #   command: 'echo "Single command: $WEBHOOK_PAYLOAD"'
  #   description: 'Single command example (backward compatible)'

  # Example with restrictive webhook-specific whitelist
  # /admin-webhook:
  #   commands:
  #   - 'echo "Admin action: $WEBHOOK_PAYLOAD" >> /tmp/admin.log'
  #   - 'sudo systemctl restart myservice'
  #   description: 'Admin webhook with strict IP whitelist'
  #   whitelist:
  #   - '192.168.1.100'  # Only allow from admin workstation
  #   - '10.0.0.5'       # Backup admin machine
    
  # Example with open webhook (empty whitelist overrides global)
  # /public-webhook:
  #   commands:
  #   - 'echo "Public webhook: $WEBHOOK_PAYLOAD" >> /tmp/public.log'
  #   description: 'Public webhook accessible from any IP'
  #   whitelist: []  # Empty list means allow all IPs for this webhook

# IP whitelist - who can call these webhooks
# Supports individual IPs, CIDR notation, and IPv6
whitelist:
- '127.0.0.1'        # localhost IPv4
- '::1'              # localhost IPv6
- '10.0.0.0/21'       # Private network range
  # - '203.0.113.0/24' # Example: specific external network

# Server configuration
port: 8999
host: '0.0.0.0'  # Listen on all interfaces. Use '127.0.0.1' for localhost only
