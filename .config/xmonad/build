#!/bin/sh

# XMonad build script - use system packages only
#
# TROUBLESHOOTING HISTORY:
# This script was updated to fix the "Ambiguous module name" error that occurred
# when GHC found duplicate packages. The error looked like:
#   "Ambiguous module name 'XMonad': it was found in multiple packages: xmonad-0.18.0 xmonad-0.18.0"
#
# ROOT CAUSE:
# The issue was caused by having the same packages registered in multiple GHC package
# databases (system-wide and user/cabal). GHC was seeing duplicates when both were active.
#
# SOLUTION:
# 1. Remove any .ghc.environment.* files that tell GHC to use additional package databases
# 2. Use -hide-all-packages to ignore all packages by default
# 3. Explicitly specify only the packages we need with -package flags
# This ensures GHC only uses packages from one location (system packages).

cd /var/home/zach/.config/xmonad

# Clear any environment files that might cause conflicts
# These .ghc.environment.* files can cause "Ambiguous module name" errors
# when packages are registered in multiple package databases (system + user/cabal)
rm -f .ghc.environment.* 2>/dev/null

# Detect system architecture
ARCH=$(uname -m)
if [ "$ARCH" = "x86_64" ]; then
    XMONAD_ARCH="x86_64-linux"
elif [ "$ARCH" = "aarch64" ]; then
    XMONAD_ARCH="aarch64-linux"
else
    # Fallback for other architectures
    XMONAD_ARCH="${ARCH}-linux"
fi

# Build with system packages only
# Hide all packages by default to avoid conflicts, then explicitly add only what we need
# This ensures GHC uses only one version of each package from the system package database
exec ghc --make xmonad.hs \
    -i \
    -ilib \
    -fforce-recomp \
    -main-is main \
    -v0 \
    -outputdir /var/home/zach/.cache/xmonad/build-${XMONAD_ARCH} \
    -o /var/home/zach/.cache/xmonad/xmonad-${XMONAD_ARCH} \
    -hide-all-packages \
    -package base \
    -package xmonad \
    -package xmonad-contrib \
    -package unix \
    -package process \
    -package containers \
    -package mtl \
    -package X11